<% info    = @spec.fetch("info", {}) %>
<% servers = @spec.fetch("servers", []) %>
<% paths   = @spec.fetch("paths", {}) %>
<% base_url = (servers.first && servers.first["url"].presence) || request.base_url %>
<% base_url = base_url.to_s.chomp("/") %>
<% example_value = lambda do |param|
     value = param["example"]
     value = param.dig("schema", "example") if value.blank?
     value = param.dig("schema", "default") if value.blank?
     value = "loftwah" if value.blank? && param["name"] == "username"
     value = "<#{param["name"]}>" if value.blank?
     value.to_s
   end %>

<section class="mx-auto max-w-screen-xl space-y-10 px-4 py-12">
  <header class="flex flex-col gap-6 md:flex-row md:items-end md:justify-between">
    <div class="space-y-3">
      <p class="inline-flex items-center gap-2 rounded-full border border-emerald-100 bg-emerald-50 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-emerald-600 dark:border-emerald-900/70 dark:bg-emerald-900/30 dark:text-emerald-300">
        Public API
      </p>
      <div>
        <h1 class="text-3xl font-bold text-slate-900 dark:text-slate-100"><%= info["title"] || "TecHub API" %></h1>
        <% if info["description"].present? %>
          <p class="mt-2 text-base text-slate-600 dark:text-slate-300 max-w-2xl">
            <%= simple_format(info["description"].strip, {}, wrapper_tag: "span") %>
          </p>
        <% end %>
      </div>
      <dl class="flex flex-wrap items-center gap-3 text-xs font-medium text-slate-500 dark:text-slate-400">
        <% if info["version"].present? %>
          <div class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 dark:border-slate-700">
            <span class="font-semibold text-slate-700 dark:text-slate-200">Version</span>
            <span><%= info["version"] %></span>
          </div>
        <% end %>
        <% servers.each do |server| %>
          <div class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 dark:border-slate-700">
            <span class="font-semibold text-slate-700 dark:text-slate-200">Server</span>
            <code class="text-xs text-slate-700 dark:text-slate-200"><%= server["url"] %></code>
          </div>
        <% end %>
      </dl>
    </div>
    <%= link_to api_docs_spec_path, class: "inline-flex items-center justify-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:text-slate-900 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:hover:border-slate-600 dark:hover:text-slate-100" do %>
      <i class="fa-regular fa-file-code text-sm"></i>
      <span>Download OpenAPI</span>
    <% end %>
  </header>

  <% if paths.blank? %>
    <div class="rounded-xl border border-amber-200 bg-amber-50 p-6 text-sm text-amber-800 dark:border-amber-800 dark:bg-amber-900/20 dark:text-amber-100">
      The OpenAPI document could not be loaded. Add a spec at <code>docs/api/openapi.yaml</code> to surface endpoint documentation.
    </div>
  <% else %>
    <div class="space-y-8">
      <% paths.sort_by { |path,| path }.each do |path, verbs| %>
        <article class="rounded-2xl border border-slate-200 bg-white/95 shadow-sm transition dark:border-slate-700 dark:bg-slate-900/70">
          <header class="border-b border-slate-200 px-4 py-4 dark:border-slate-700">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100">
              <code class="rounded bg-slate-100 px-2 py-1 text-sm font-mono dark:bg-slate-800 dark:text-slate-100"><%= path %></code>
            </h2>
          </header>

          <div class="divide-y divide-slate-200 dark:divide-slate-800">
            <% verbs.sort_by { |verb,| verb }.each do |verb, config| %>
              <% summary = config["summary"].presence || verb.upcase %>
              <details class="group open:bg-slate-50/80 open:dark:bg-slate-900/60">
                <summary class="flex cursor-pointer flex-col gap-2 px-4 py-4 text-sm transition group-open:bg-slate-100/70 dark:group-open:bg-slate-900/60 md:flex-row md:items-center md:justify-between">
                  <div class="flex items-center gap-3">
                    <span class="inline-flex min-w-[72px] items-center justify-center rounded-full border px-3 py-1 text-xs font-semibold uppercase tracking-wide <%= verb_badge_classes(verb) %>"><%= verb %></span>
                    <span class="font-medium text-slate-900 dark:text-slate-100"><%= summary %></span>
                  </div>
                  <div class="flex items-center gap-3 text-xs text-slate-400 dark:text-slate-500">
                    <% if config["operationId"].present? %>
                      <code class="text-xs text-slate-500 dark:text-slate-400"><%= config["operationId"] %></code>
                    <% end %>
                    <div class="flex items-center gap-1">
                      <span class="hidden text-[11px] font-medium uppercase tracking-wide md:inline-block">Expand</span>
                      <i class="fa-solid fa-chevron-down text-sm transition duration-200 group-open:rotate-180"></i>
                    </div>
                  </div>
                </summary>

                <div
                  class="space-y-6 px-4 py-5 text-sm text-slate-700 dark:text-slate-200"
                  data-controller="api-doc-example"
                  data-api-doc-example-base-url-value="<%= base_url %>"
                  data-api-doc-example-path-value="<%= path %>"
                  data-api-doc-example-verb-value="<%= verb.upcase %>"
                >
                  <% parameters = Array(config["parameters"]) %>
                  <% path_params = parameters.select { |param| param["in"] == "path" } %>
                  <% query_params = parameters.select { |param| param["in"] == "query" } %>
                  <% placeholder_path = path.gsub(/\{([^}]+)\}/) { "<#{$1}>" } %>
                  <% query_examples = query_params.map { |param| "#{param["name"]}=#{example_value.call(param)}" } %>
                  <% query_hint = query_examples.any? ? "?#{query_examples.join("&")}" : "" %>
                  <% display_url = "#{base_url}#{placeholder_path}#{query_hint}" %>
                  <% curl_example = "curl -sS -X #{verb.upcase} '#{display_url}'" %>
                  <% fetch_example = <<~JS
fetch('#{display_url}', {
  method: '#{verb.upcase}',
  headers: {
    'Accept': 'application/json'
  }
})
  .then((response) => response.json())
  .then((data) => console.log(data));
JS
 %>
                  <% if config["description"].present? %>
                    <p class="leading-relaxed"><%= config["description"] %></p>
                  <% end %>

                  <div class="space-y-3 rounded-xl border border-slate-200 bg-white/70 p-4 dark:border-slate-700 dark:bg-slate-900/40">
                    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                      <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Quick start snippets</h3>
                      <div class="flex items-center gap-2">
                        <button
                          type="button"
                          class="inline-flex items-center gap-2 rounded-lg border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-emerald-700 transition hover:border-emerald-300 hover:bg-emerald-100 dark:border-emerald-500/40 dark:bg-emerald-900/30 dark:text-emerald-200"
                          data-action="api-doc-example#copyCurl"
                        >
                          <i class="fa-solid fa-copy text-[11px]"></i>
                          Copy curl
                        </button>
                        <button
                          type="button"
                          class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:border-slate-300 hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300 dark:hover:border-slate-600 dark:hover:bg-slate-800/70"
                          data-action="api-doc-example#copyFetch"
                        >
                          <i class="fa-solid fa-code text-[11px]"></i>
                          Copy fetch
                        </button>
                        <span class="text-[11px] font-semibold uppercase tracking-wide text-emerald-600 transition-opacity duration-150 hidden" data-api-doc-example-target="copyNotice"></span>
                      </div>
                    </div>
                    <div class="space-y-4">
                      <div class="space-y-2">
                        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Run from your terminal</p>
                        <pre class="overflow-x-auto rounded bg-slate-900 p-3 text-[11px] text-slate-100 dark:bg-slate-950" data-api-doc-example-target="curl"><code><%= h(curl_example) %></code></pre>
                      </div>
                      <div class="space-y-2">
                        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Use in JavaScript</p>
                        <pre class="overflow-x-auto rounded bg-slate-900 p-3 text-[11px] text-slate-100 dark:bg-slate-950" data-api-doc-example-target="fetch"><code><%= h(fetch_example.strip) %></code></pre>
                      </div>
                    </div>
                  </div>

                  <% if verb.to_s.casecmp("get").zero? %>
                    <div class="rounded-xl border border-slate-200 bg-white/70 dark:border-slate-700 dark:bg-slate-900/40">
                      <button
                        type="button"
                        class="flex w-full items-center justify-between gap-3 px-4 py-3 text-[11px] font-semibold uppercase tracking-wide text-slate-600 transition hover:bg-slate-100/60 dark:text-slate-300 dark:hover:bg-slate-800/60"
                        aria-expanded="false"
                        data-action="api-doc-example#toggleTry"
                      >
                        <span>Try it now</span>
                        <i class="fa-solid fa-chevron-down text-xs transition duration-200" data-api-doc-example-target="toggleIcon"></i>
                      </button>
                      <div class="space-y-4 border-t border-slate-200 px-4 py-4 text-xs dark:border-slate-800 hidden" data-api-doc-example-target="tryPanel">
                        <form class="space-y-4" data-api-doc-example-target="form" data-action="submit->api-doc-example#send">
                          <% if path_params.any? %>
                            <div class="space-y-2">
                              <h4 class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Path parameters</h4>
                              <div class="grid gap-3 md:grid-cols-2">
                                <% path_params.each do |param| %>
                                  <% suggested = example_value.call(param) %>
                                  <label class="space-y-1">
                                    <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-300"><%= param["name"] %></span>
                                    <input
                                      type="text"
                                      name="<%= param["name"] %>"
                                      value="<%= suggested %>"
                                      required
                                      class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm transition focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-200 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100 dark:focus:border-emerald-400"
                                      data-api-doc-example-target="pathInput"
                                    >
                                    <% if param["description"].present? %>
                                      <p class="text-[11px] text-slate-500 dark:text-slate-400"><%= param["description"] %></p>
                                    <% end %>
                                  </label>
                                <% end %>
                              </div>
                            </div>
                          <% end %>

                          <% if query_params.any? %>
                            <div class="space-y-2">
                              <h4 class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Query parameters</h4>
                              <div class="grid gap-3 md:grid-cols-2">
                                <% query_params.each do |param| %>
                                  <% suggested = example_value.call(param) %>
                                  <% schema = param["schema"] || {} %>
                                  <% input_type =
                                       case schema["type"]
                                       when "integer", "number" then "number"
                                       else "text"
                                       end %>
                                  <% min = schema["minimum"] %>
                                  <% max = schema["maximum"] %>
                                  <% has_prefill = param["example"].present? || schema["example"].present? || schema["default"].present? %>
                                  <label class="space-y-1">
                                    <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-600 dark:text-slate-300"><%= param["name"] %></span>
                                    <input
                                      type="<%= input_type %>"
                                      name="<%= param["name"] %>"
                                      value="<%= has_prefill ? suggested : "" %>"
                                      <%= "min=\"#{min}\"" if min.present? %>
                                      <%= "max=\"#{max}\"" if max.present? %>
                                      placeholder="<%= has_prefill ? "" : suggested %>"
                                      class="w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm transition focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-200 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-100 dark:focus:border-emerald-400"
                                      data-api-doc-example-target="queryInput"
                                      <%= "required" if param["required"] %>
                                    >
                                    <% if param["description"].present? %>
                                      <p class="text-[11px] text-slate-500 dark:text-slate-400"><%= param["description"] %></p>
                                    <% end %>
                                  </label>
                                <% end %>
                              </div>
                            </div>
                          <% end %>

                          <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                            <button
                              type="submit"
                              class="inline-flex items-center justify-center gap-2 rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-emerald-700 transition hover:border-emerald-300 hover:bg-emerald-100 dark:border-emerald-500/40 dark:bg-emerald-900/30 dark:text-emerald-200 dark:hover:border-emerald-400"
                            >
                              <i class="fa-solid fa-paper-plane text-[11px]"></i>
                              Send request
                            </button>
                            <p class="text-[11px] font-medium text-slate-500 dark:text-slate-400" data-api-doc-example-target="status"></p>
                          </div>
                        </form>
                        <pre class="hidden overflow-x-auto rounded bg-slate-900 p-3 text-[11px] text-slate-100 dark:bg-slate-950" data-api-doc-example-target="response"></pre>
                      </div>
                    </div>
                  <% end %>

                  <% if parameters.any? %>
                    <div class="space-y-3">
                      <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Parameters</h3>
                      <div class="overflow-hidden rounded-xl border border-slate-200 dark:border-slate-800">
                        <table class="min-w-full divide-y divide-slate-200 text-left text-xs dark:divide-slate-800">
                          <thead class="bg-slate-50 text-slate-600 dark:bg-slate-900 dark:text-slate-300">
                            <tr>
                              <th class="px-3 py-2 font-semibold">Name</th>
                              <th class="px-3 py-2 font-semibold">In</th>
                              <th class="px-3 py-2 font-semibold">Type</th>
                              <th class="px-3 py-2 font-semibold">Description</th>
                            </tr>
                          </thead>
                          <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
                            <% parameters.each do |param| %>
                              <% schema = param.fetch("schema", {}) %>
                              <tr class="bg-white last:border-0 dark:bg-slate-950/50">
                                <td class="px-3 py-2 font-medium text-slate-900 dark:text-slate-100">
                                  <code><%= param["name"] %></code>
                                  <% if param["required"] %>
                                    <span class="ml-1 rounded-full bg-emerald-100 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-300">Required</span>
                                  <% end %>
                                </td>
                                <td class="px-3 py-2 uppercase text-slate-600 dark:text-slate-300"><%= param["in"] %></td>
                                <td class="px-3 py-2 text-slate-600 dark:text-slate-300"><%= schema["type"] %></td>
                                <td class="px-3 py-2 text-slate-600 dark:text-slate-300"><%= param["description"] %></td>
                              </tr>
                            <% end %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  <% end %>

                  <% request_body = config.dig("requestBody", "content") %>
                  <% if request_body.present? %>
                    <div class="space-y-3">
                      <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Request body</h3>
                      <% request_body.each do |content_type, details| %>
                        <div class="rounded-xl border border-slate-200 bg-slate-50/70 p-4 dark:border-slate-800 dark:bg-slate-900/60">
                          <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400"><%= content_type %></p>
                          <% if details["schema"] %>
                            <pre class="overflow-x-auto rounded-lg bg-slate-900 p-4 text-xs text-slate-100 shadow-inner dark:bg-slate-950"><code><%= JSON.pretty_generate(details["schema"]) %></code></pre>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>

                  <% responses = config.fetch("responses", {}) %>
                  <% if responses.any? %>
                    <div class="space-y-3">
                      <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Responses</h3>
                      <div class="space-y-3">
                        <% responses.each do |status, response| %>
                          <div class="rounded-xl border border-slate-200 bg-white/80 p-4 dark:border-slate-800 dark:bg-slate-900/60">
                            <div class="flex items-center justify-between gap-3">
                              <span class="inline-flex min-w-[64px] items-center justify-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700 dark:bg-slate-800 dark:text-slate-200"><%= status %></span>
                              <p class="flex-1 text-right text-xs text-slate-500 dark:text-slate-400"><%= response["description"] %></p>
                            </div>
                            <% response.fetch("content", {}).each do |content_type, details| %>
                              <div class="mt-3 rounded-lg border border-slate-200 bg-slate-50/70 p-3 text-xs dark:border-slate-800 dark:bg-slate-900/60">
                                <p class="mb-2 font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400"><%= content_type %></p>
                                <% if example = details["example"] %>
                                  <pre class="overflow-x-auto rounded bg-slate-900 p-3 text-[11px] text-slate-100 dark:bg-slate-950"><code><%= JSON.pretty_generate(example) rescue example %></code></pre>
                                <% elsif schema = details["schema"] %>
                                  <pre class="overflow-x-auto rounded bg-slate-900 p-3 text-[11px] text-slate-100 dark:bg-slate-950"><code><%= JSON.pretty_generate(schema) %></code></pre>
                                <% end %>
                              </div>
                            <% end %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </details>
            <% end %>
          </div>
        </article>
      <% end %>
    </div>
  <% end %>
</section>
