<%# 1500x500 banner view used for screenshot capture %>
<section class="relative h-[<%= (@canvas_h || 500).to_i %>px] w-[<%= (@canvas_w || 1500).to_i %>px] overflow-hidden">
  <% card = @profile.profile_card %>
  <%# Prefer library art when AI art is not opted-in %>
  <% if !@profile.ai_art_opt_in %>
    <% bg_url = supporting_art_url_for(login: @profile.login, aspect: :banner) %>
  <% else %>
    <%# Background image selection for banner: prefer avatar_3x1 then card/og %>
    <% bg_url = nil %>
    <% if (asset = @profile.profile_assets.find_by(kind: 'avatar_3x1')) && asset.public_url.present? %>
      <% bg_url = asset.public_url %>
    <% elsif (asset = @profile.profile_assets.find_by(kind: 'card')) && asset.public_url.present? %>
      <% bg_url = asset.public_url %>
    <% elsif (asset = @profile.profile_assets.find_by(kind: 'og')) && asset.public_url.present? %>
      <% bg_url = asset.public_url %>
    <% else %>
      <% base = Rails.root.join('public','generated', @profile.login) %>
      <% local = Dir[base.join('avatar-3x1*.{jpg,jpeg,png}').to_s].first || Dir[base.join('card*.{jpg,jpeg,png}').to_s].first || Dir[base.join('og*.{jpg,jpeg,png}').to_s].first %>
      <% bg_url = "/generated/#{@profile.login}/#{File.basename(local)}" if local %>
    <% end %>
    <% if bg_url.nil? %>
      <% bg_url = supporting_art_url_for(login: @profile.login, aspect: :banner) %>
    <% end %>
  <% end %>
  <% if bg_url.present? %>
    <img src="<%= bg_url %>" alt="banner" class="absolute inset-0 h-full w-full object-cover opacity-25" />
  <% else %>
    <div class="absolute inset-0 bg-gradient-to-r from-indigo-600 via-sky-600 to-cyan-500 opacity-30"></div>
  <% end %>
  <div class="absolute inset-0 bg-black/40"></div>
  <%# Safe area padding: bring content in from edges %>
  <div class="absolute inset-0 flex items-center justify-between px-24">
    <div class="min-w-0">
      <% name = @profile.display_name %>
      <% handle = @profile.login %>
      <% name_size = name.to_s.length > 22 ? "text-3xl" : "text-4xl" %>
      <div class="<%= name_size %> font-extrabold text-white drop-shadow tracking-wide leading-tight truncate"><%= name %></div>
      <div class="mt-0.5 text-white/90">@<%= handle %></div>
      <% if card&.tagline.present? %>
        <div class="mt-1 text-slate-200 text-sm max-w-[640px] truncate"><%= card.tagline %></div>
      <% end %>
      <% repos = Array(@profile.top_repositories).first(3).map { |r| [r.name.to_s, r.stargazers_count.to_i] } %>
      <% if repos.any? %>
        <div class="mt-2 flex flex-wrap items-center gap-2">
          <% repos.each do |(rn, stars)| %>
            <span class="px-2 py-1 rounded-full bg-white/10 border border-white/20 text-white/90 text-xs max-w-[320px] truncate">
              <%= rn %>
              <% if stars > 0 %><span class="ml-1 text-[10px] text-amber-300">‚òÖ <%= stars %></span><% end %>
            </span>
          <% end %>
        </div>
      <% end %>
      <%# Extra context chips: top language and metrics %>
      <div class="mt-2 flex items-center gap-2 text-white/95">
        <% top_lang = @profile.profile_languages.order(count: :desc).limit(1).pluck(:name).first %>
        <% if top_lang.present? %>
          <span class="px-2 py-1 rounded-md bg-white/10 border border-white/20 text-[12px]">üíª <%= top_lang %></span>
        <% end %>
        <% followers = @profile.followers.to_i %>
        <% stars_total = Array(@profile.top_repositories).sum { |r| r.stargazers_count.to_i } %>
        <span class="px-2 py-1 rounded-md bg-white/10 border border-white/20 text-[12px]">‚≠ê <%= stars_total %></span>
        <span class="px-2 py-1 rounded-md bg-white/10 border border-white/20 text-[12px]">üë• <%= followers %></span>
      </div>
    </div>
    <div class="flex items-center gap-6">
      <div class="hidden md:block text-slate-200/85 text-xs tracking-wide">techub.life</div>
      <div class="h-28 w-28 overflow-hidden rounded-full border-4 border-white/80 shadow-xl">
        <% avatar_choice = @profile.profile_card&.avatar_choice || 'real' %>
        <% avatar_choice = 'real' unless @profile.ai_art_opt_in %>
        <% ai_avatar = @profile.profile_assets.find_by(kind: 'avatar_1x1') %>
        <% avatar_src = avatar_image_url_for(@profile) %>
        <img src="<%= avatar_src %>" alt="avatar" class="h-full w-full object-cover" onerror="this.onerror=null; this.src='<%= asset_path("android-chrome-512x512.jpg") %>'" />
      </div>
    </div>
  </div>
</section>

