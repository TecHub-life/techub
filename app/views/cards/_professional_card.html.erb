<% variant = variant.to_sym %>
<% canvas_w = (@canvas_w || (variant == :og_pro ? 1200 : 1280)).to_i %>
<% canvas_h = (@canvas_h || (variant == :og_pro ? 630 : 720)).to_i %>
<% suffix = variant == :og_pro ? "og" : "card" %>
<% card_prefs = @profile.profile_card %>
<% choice = card_prefs&.public_send("bg_choice_#{suffix}") || "default" %>
<% color_hex = card_prefs&.public_send("bg_color_#{suffix}") || "#0f172a" %>
<% fx = card_prefs&.public_send("bg_fx_#{suffix}") || 0.5 %>
<% fy = card_prefs&.public_send("bg_fy_#{suffix}") || 0.5 %>
<% zoom = card_prefs&.public_send("bg_zoom_#{suffix}") || 1.0 %>
<% aspect = suffix == "og" ? :og : :card %>
<% gen_dir = Rails.root.join("public", "generated", @profile.login) %>
<% bg_url = nil %>
<% if choice == "ai" && @profile.ai_art_opt_in %>
  <% asset_bg16 = @profile.profile_assets.find_by(kind: "avatar_16x9") %>
  <% asset_card = @profile.profile_assets.find_by(kind: "card") %>
  <% if asset_bg16&.public_url.present? %>
    <% bg_url = asset_bg16.public_url %>
  <% elsif asset_card&.public_url.present? %>
    <% bg_url = asset_card.public_url %>
  <% elsif Dir.exist?(gen_dir) %>
    <% file = Dir[gen_dir.join("avatar-16x9*.jpg").to_s].first || Dir[gen_dir.join("avatar-16x9*.png").to_s].first || Dir[gen_dir.join("card-bg-16x9*.jpg").to_s].first || Dir[gen_dir.join("card-bg-16x9*.png").to_s].first %>
    <% bg_url = "/generated/#{@profile.login}/#{File.basename(file)}" if file %>
  <% end %>
  <% if bg_url.nil? %>
    <% bg_url = supporting_art_url_for(login: @profile.login, aspect: aspect) %>
  <% end %>
<% elsif choice == "default" || (choice == "ai" && !@profile.ai_art_opt_in) %>
  <% bg_url = supporting_art_url_for(login: @profile.login, aspect: aspect) %>
<% end %>
<% name = @profile.display_name %>
<% handle = @profile.login %>
<% name_length = name.to_s.length %>
<% name_class =
    if variant == :og_pro
      name_length > 26 ? "text-3xl" : name_length > 18 ? "text-4xl" : "text-5xl"
    else
      name_length > 26 ? "text-4xl" : name_length > 18 ? "text-5xl" : "text-6xl"
    end %>
<% handle_class = variant == :og_pro ? "text-lg md:text-xl" : "text-xl md:text-2xl" %>
<% card = @profile.profile_card %>
<% short_bio = card&.short_bio.presence || @profile.summary.presence || @profile.bio %>
<% bio_excerpt = short_bio.to_s.truncate(260) %>
<% languages = @profile.top_languages(5).to_a %>
<% total_language_count = languages.sum(&:count).to_f %>
<% followers = @profile.followers.to_i %>
<% repos = @profile.public_repos.to_i %>
<% stars = Array(@profile.top_repositories).sum { |r| r.stargazers_count.to_i } %>
<% blog_url = @profile.blog.to_s.presence %>
<% nice_blog = blog_url.to_s.gsub(%r{https?://}, "").gsub(/^www\./, "") if blog_url.present? %>
<% twitter = @profile.twitter_username.to_s.presence %>
<% email = @profile.email.to_s.presence %>
<% location = @profile.location.to_s.presence %>
<% company = @profile.company.to_s.presence %>
<% contact_rows = [] %>
<% contact_rows << ["Website", nice_blog] if nice_blog.present? %>
<% contact_rows << ["Email", email] if email.present? %>
<% contact_rows << ["Location", location] if location.present? %>
<% contact_rows << ["Company", company] if company.present? %>
<% contact_rows << ["Twitter", "@#{twitter}"] if twitter.present? %>

<% background_color = (choice == "color") ? color_hex : "#0b1220" %>
<div class="relative overflow-hidden rounded-[32px]" style="width: <%= canvas_w %>px; height: <%= canvas_h %>px;">
  <div class="absolute inset-0" style="background:<%= background_color %>;"></div>
  <% if choice != "color" && bg_url.present? %>
    <img src="<%= bg_url %>" alt="Background" class="absolute inset-0 w-full h-full object-cover opacity-35" style="<%= bg_style_from(fx: fx, fy: fy, zoom: zoom) %>">
  <% end %>
  <div class="absolute inset-0 bg-gradient-to-br from-slate-950/80 via-slate-950/65 to-slate-900/60"></div>

  <div class="relative z-10 flex h-full flex-col px-10 py-8">
    <div class="flex w-full flex-1 flex-col gap-8 lg:flex-row lg:items-start">
      <div class="flex flex-col items-center gap-4 lg:items-start">
        <div class="rounded-full bg-slate-900/60 p-1.5 shadow-[0_18px_48px_rgba(15,23,42,0.55)]">
          <div class="h-40 w-40 overflow-hidden rounded-full bg-slate-800 lg:h-44 lg:w-44">
            <% avatar_src = avatar_image_url_for(@profile) %>
            <% if avatar_src.present? %>
              <img src="<%= avatar_src %>" alt="<%= name %> avatar" class="h-full w-full object-cover object-center" onerror="this.onerror=null; this.src='<%= asset_path("android-chrome-512x512.jpg") %>'">
            <% else %>
              <div class="flex h-full w-full items-center justify-center bg-slate-700 text-3xl text-slate-400">?</div>
            <% end %>
          </div>
        </div>
        <% if card&.title.present? %>
          <span class="rounded-full bg-white/10 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-100 backdrop-blur"><%= card.title %></span>
        <% end %>
      </div>

      <div class="grid flex-1 grid-cols-1 gap-6 lg:grid-cols-[minmax(0,1fr)_280px] xl:grid-cols-[minmax(0,1fr)_320px]">
        <div class="flex min-w-0 flex-col gap-4">
          <div class="space-y-1">
            <h1 class="<%= name_class %> font-bold tracking-tight text-white drop-shadow-sm leading-tight"><%= name %></h1>
            <p class="<%= handle_class %> font-semibold text-sky-300">@<%= handle %></p>
          </div>

          <% if card&.tagline.present? %>
            <p class="text-base font-medium text-slate-200"><%= card.tagline %></p>
          <% end %>

          <% if bio_excerpt.present? %>
            <p class="text-base leading-relaxed text-slate-100/85"><%= bio_excerpt %></p>
          <% end %>

          <% if languages.any? %>
            <div class="space-y-2">
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-300">Languages</p>
              <div class="flex flex-wrap gap-2">
                <% languages.each do |lang| %>
                  <% pct = total_language_count.positive? ? ((lang.count.to_f / total_language_count) * 100).round : nil %>
                  <span class="rounded-full border border-white/15 bg-white/10 px-3 py-1 text-sm font-medium text-white">
                    <%= lang.name %><%= pct ? " â€¢ #{pct}%" : "" %>
                  </span>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if card&.long_bio.present? %>
            <div class="space-y-2">
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-300">Highlights</p>
              <p class="text-sm text-slate-200/90 leading-relaxed"><%= card.long_bio.to_s.truncate(320) %></p>
            </div>
          <% end %>
        </div>

        <aside class="flex flex-col gap-4">
          <div class="rounded-2xl border border-white/10 bg-white/8 p-4 backdrop-blur">
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-200/80">Snapshot</p>
            <div class="mt-3 grid grid-cols-1 gap-2 text-sm text-slate-100 sm:grid-cols-3 sm:gap-3">
              <div class="rounded-lg bg-slate-900/60 px-3 py-2 text-center shadow-inner">
                <p class="text-2xl font-semibold text-white"><%= number_with_delimiter(followers) %></p>
                <p class="text-[11px] uppercase tracking-wide text-slate-300/80">Followers</p>
              </div>
              <div class="rounded-lg bg-slate-900/60 px-3 py-2 text-center shadow-inner">
                <p class="text-2xl font-semibold text-white"><%= number_with_delimiter(stars) %></p>
                <p class="text-[11px] uppercase tracking-wide text-slate-300/80">Stars</p>
              </div>
              <div class="rounded-lg bg-slate-900/60 px-3 py-2 text-center shadow-inner">
                <p class="text-2xl font-semibold text-white"><%= number_with_delimiter(repos) %></p>
                <p class="text-[11px] uppercase tracking-wide text-slate-300/80">Public Repos</p>
              </div>
            </div>
          </div>

          <% if contact_rows.any? %>
            <div class="rounded-2xl border border-white/10 bg-white/8 p-4 backdrop-blur">
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-200/80">Contact</p>
              <div class="mt-3 space-y-2 text-sm text-slate-100/90">
                <% contact_rows.each do |label, value| %>
                  <div class="flex items-start gap-2">
                    <span class="min-w-[70px] text-xs font-semibold uppercase tracking-wide text-slate-300/90"><%= label %></span>
                    <span class="flex-1 break-words font-medium text-white"><%= value %></span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if @profile.hireable_display? %>
            <div class="rounded-2xl border border-emerald-200/40 bg-emerald-500/15 p-4 text-emerald-100 backdrop-blur">
              <p class="text-sm font-semibold">Open to opportunities</p>
              <p class="text-xs text-emerald-100/80">Reach out to collaborate or hire.</p>
            </div>
          <% end %>
        </aside>
      </div>
    </div>
  </div>
</div>
