<%# Page metadata for sharing %>
<%
  title_text = (@profile&.display_name.presence || @profile&.login || params[:username]).to_s
  desc_text = @profile&.bio.presence || "GitHub profile insights and AI trading card"
  content_for :title, "#{title_text} – TecHub"
  content_for :description, desc_text

  og_url = nil
  begin
    if @profile
      og_asset = @profile.profile_assets.find_by(kind: "og")
      if og_asset&.public_url.present?
        og_url = og_asset.public_url
      else
        base = Rails.root.join("public", "generated", @profile.login)
        rel = nil
        if File.exist?(base.join("og.jpg"))
          rel = "/generated/#{@profile.login}/og.jpg"
        elsif File.exist?(base.join("og.png"))
          rel = "/generated/#{@profile.login}/og.png"
        end
        og_url = rel.present? ? (request.base_url + rel) : nil
      end
    end
  rescue StandardError
    og_url = nil
  end
  content_for :og_image, og_url if og_url.present?
  content_for :twitter_image, og_url if og_url.present?
%>

<%# JSON-LD Structured Data for Profile %>
<% if @profile.present? %>
  <% json_ld = {
    "@context" => "https://schema.org",
    "@type" => "Person",
    "name" => @profile.display_name,
    "url" => request.original_url,
    "image" => @profile.avatar_url,
    "description" => (@profile.profile_card&.short_bio.presence || @profile.bio).to_s,
    "sameAs" => [@profile.html_url, (@profile.blog if @profile.blog.present?)].compact,
    "additionalProperty" => [
      { "@type" => "PropertyValue", "name" => "attack", "value" => @profile.profile_card&.attack },
      { "@type" => "PropertyValue", "name" => "defense", "value" => @profile.profile_card&.defense },
      { "@type" => "PropertyValue", "name" => "speed", "value" => @profile.profile_card&.speed },
      { "@type" => "PropertyValue", "name" => "playing_card", "value" => @profile.profile_card&.playing_card },
      { "@type" => "PropertyValue", "name" => "spirit_animal", "value" => @profile.profile_card&.spirit_animal },
      { "@type" => "PropertyValue", "name" => "archetype", "value" => @profile.profile_card&.archetype }
    ]
  } %>
  <script type="application/ld+json">
    <%= json_ld.to_json.html_safe %>
  </script>
<% end %>

<section class="mx-auto max-w-6xl px-4 py-8 sm:py-12">
  <% if @profile.present? %>
    <% og_banner = (og_image_url(login: @profile.login, format: :jpg) rescue nil) %>
    <div class="relative w-full h-44 sm:h-56 md:h-64 rounded-xl overflow-hidden mb-12">
      <% if og_banner.present? %>
        <img src="<%= og_banner %>" alt="OG banner" class="absolute inset-0 w-full h-full object-cover" loading="lazy">
      <% else %>
        <div class="absolute inset-0 bg-gradient-to-r from-indigo-900 to-purple-900"></div>
      <% end %>
      <div class="absolute inset-0 bg-black/35"></div>
      <div class="absolute bottom-4 left-4 right-4 flex items-center gap-3">
        <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-full overflow-hidden ring-2 ring-white/80 bg-slate-700">
          <% if @profile.avatar_url.present? %>
            <img src="<%= @profile.avatar_url %>" alt="<%= @profile.display_name %> avatar" class="w-full h-full object-cover" loading="lazy">
          <% end %>
        </div>
        <div class="min-w-0">
          <div class="text-white text-xl sm:text-2xl font-bold truncate"><%= @profile.display_name %></div>
          <div class="text-white/90 text-sm sm:text-base truncate">@<%= @profile.login %></div>
        </div>
      </div>
    </div>
  <% end %>

  <% if @profile.present? %>
    <div class="grid gap-8 lg:grid-cols-3">
      <!-- Card Artifacts (cards-first) -->
      <div class="lg:col-span-3">
        <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6">
          <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4">Card Artifacts</h2>
          <div class="grid gap-4 md:grid-cols-3">
            <% base = Rails.root.join("public", "generated", @profile.login) %>
            <% og_img = if File.exist?(base.join("og.jpg"))
              "/generated/#{@profile.login}/og.jpg"
            elsif File.exist?(base.join("og.png"))
              "/generated/#{@profile.login}/og.png"
            else
              (og_image_path(login: @profile.login, format: :jpg) rescue nil)
            end %>
            <% card_img = if File.exist?(base.join("card.jpg"))
              "/generated/#{@profile.login}/card.jpg"
            elsif File.exist?(base.join("card.png"))
              "/generated/#{@profile.login}/card.png"
            end %>
            <% simple_img = if File.exist?(base.join("simple.jpg"))
              "/generated/#{@profile.login}/simple.jpg"
            elsif File.exist?(base.join("simple.png"))
              "/generated/#{@profile.login}/simple.png"
            end %>
            <% thumbs = [
              ["OpenGraph", og_img],
              ["Card", card_img],
              ["Simple", simple_img]
            ] %>
            <% thumbs.each do |label, img| %>
              <div class="rounded border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div class="text-xs font-medium px-3 py-2 bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-300"><%= label %></div>
                <% if img.present? %>
                  <img src="<%= img %>" alt="<%= label %> preview" class="w-full aspect-video object-cover bg-slate-100 dark:bg-slate-800" loading="lazy">
                <% else %>
                  <div class="w-full aspect-video flex items-center justify-center bg-slate-100 dark:bg-slate-800 text-slate-400 text-xs">No image</div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      <!-- Profile Info -->
      <div class="lg:col-span-1">
        <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6">
          <% avatar_path = @profile.avatar_url.presence %>
          <img src="<%= avatar_path %>" alt="<%= @profile.login %>" class="w-32 h-32 rounded-full mb-4">
          
          <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-1">
            <%= @profile.display_name %>
          </h2>
          
          <p class="text-slate-600 dark:text-slate-400 mb-4">
            @<%= @profile.login %>
          </p>
          
          <% if @profile.profile_card&.long_bio.present? %>
            <p class="text-slate-700 dark:text-slate-300 mb-4">
              <%= @profile.profile_card.long_bio %>
            </p>
          <% elsif @profile.bio.present? %>
            <p class="text-slate-700 dark:text-slate-300 mb-4">
              <%= @profile.bio %>
            </p>
          <% end %>
          
          <div class="space-y-2 text-sm text-slate-600 dark:text-slate-400">
            <% if @profile.location.present? %>
              <p><strong>Location:</strong> <%= @profile.location %></p>
            <% end %>
            
            <% if @profile.company.present? %>
              <p><strong>Company:</strong> <%= @profile.company %></p>
            <% end %>
            
            <% if @profile.email.present? %>
              <p>
                <strong>Email:</strong>
                <a href="mailto:<%= @profile.email %>" class="text-blue-600 hover:text-blue-800 dark:text-blue-400">
                  <%= @profile.email %>
                </a>
              </p>
            <% end %>
            
            <% if @profile.blog.present? %>
              <p>
                <strong>Website:</strong> 
                <a href="<%= @profile.blog %>" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800 dark:text-blue-400">
                  <%= @profile.blog %>
                </a>
              </p>
            <% end %>
            
            <% if @profile.twitter_username.present? %>
              <p>
                <strong>Twitter:</strong>
                <a href="https://twitter.com/<%= @profile.twitter_username %>" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800 dark:text-blue-400">
                  @<%= @profile.twitter_username %>
                </a>
              </p>
            <% end %>
            
            <% if @profile.hireable %>
              <p class="text-green-600 dark:text-green-400">
                <strong>💼 Available for hire</strong>
              </p>
            <% end %>
          </div>
          
          <div class="mt-6 grid grid-cols-3 gap-4 text-center">
            <div>
              <p class="text-2xl font-bold text-slate-900 dark:text-slate-100">
                <%= @profile.followers %>
              </p>
              <p class="text-xs text-slate-600 dark:text-slate-400">Followers</p>
            </div>
            <div>
              <p class="text-2xl font-bold text-slate-900 dark:text-slate-100">
                <%= @profile.following %>
              </p>
              <p class="text-xs text-slate-600 dark:text-slate-400">Following</p>
            </div>
            <div>
              <p class="text-2xl font-bold text-slate-900 dark:text-slate-100">
                <%= @profile.public_repos %>
              </p>
              <p class="text-xs text-slate-600 dark:text-slate-400">Repos</p>
            </div>
          </div>
          
          <% if @profile.public_gists && @profile.public_gists > 0 %>
            <div class="mt-4 text-center">
              <p class="text-lg font-semibold text-slate-900 dark:text-slate-100">
                <%= @profile.public_gists %> Public Gists
              </p>
            </div>
          <% end %>
        </div>
        
        <!-- Languages -->
        <% if @languages.present? && @languages.any? %>
          <div class="mt-6 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6">
            <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-4">
              Top Languages
            </h3>
            <div class="space-y-2">
              <% @languages.first(5).each do |language| %>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-slate-700 dark:text-slate-300"><%= language.name %></span>
                  <span class="text-sm font-semibold text-slate-900 dark:text-slate-100"><%= language.count %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
        
        <!-- Social Accounts -->
        <% if @social_accounts.present? && @social_accounts.any? %>
          <div class="mt-6 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6">
            <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-4">
              Social
            </h3>
            <div class="space-y-2">
              <% @social_accounts.each do |account| %>
                <a href="<%= account.url %>" target="_blank" rel="noopener" class="flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                  <span class="font-medium"><%= account.provider.capitalize %></span>
                  <% if account.display_name.present? %>
                    <span class="text-slate-600 dark:text-slate-400">- <%= account.display_name %></span>
                  <% end %>
                </a>
              <% end %>
            </div>
          </div>
        <% end %>
        
        <!-- Organizations -->
        <% if @organizations.present? && @organizations.any? %>
          <div class="mt-6 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6">
            <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-4">
              Organizations
            </h3>
            <div class="space-y-3">
              <% @organizations.each do |org| %>
                <a href="<%= org.html_url %>" target="_blank" rel="noopener" class="flex items-center gap-3 group">
                  <img src="<%= org.avatar_url %>" alt="<%= org.login %>" class="w-10 h-10 rounded">
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-slate-900 dark:text-slate-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 truncate">
                      <%= org.name || org.login %>
                    </p>
                    <% if org.description.present? %>
                      <p class="text-xs text-slate-600 dark:text-slate-400 truncate">
                        <%= org.description %>
                      </p>
                    <% end %>
                  </div>
                </a>
              <% end %>
            </div>
          </div>
        <% end %>
        
        <!-- Recent Activity -->
        <% if @recent_activity.present? %>
          <div class="mt-6 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6">
            <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-4">
              Recent Activity
            </h3>
            
            <% if @recent_activity.last_active.present? %>
              <p class="text-sm text-slate-600 dark:text-slate-400 mb-3">
                Last active: <%= @recent_activity.last_active.strftime('%b %d, %Y') %>
              </p>
            <% end %>
            
            <% if @recent_activity.total_events && @recent_activity.total_events > 0 %>
              <p class="text-sm text-slate-700 dark:text-slate-300 mb-3">
                <strong><%= @recent_activity.total_events %></strong> events in the last 90 days
              </p>
            <% end %>
            
            <% if @recent_activity.event_breakdown.present? %>
              <div class="space-y-1 mb-4">
                <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase">Event Types</p>
                <% @recent_activity.event_breakdown.sort_by { |k, v| -v }.first(5).each do |event_type, count| %>
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-slate-600 dark:text-slate-400"><%= event_type.gsub('Event', '') %></span>
                    <span class="text-slate-900 dark:text-slate-100"><%= count %></span>
                  </div>
                <% end %>
              </div>
            <% end %>
            
            <% if @active_repositories.present? && @active_repositories.any? %>
              <div>
                <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase mb-2">Active in (Public)</p>
                <div class="space-y-2">
                  <% @active_repositories.each do |repo| %>
                    <div class="text-xs">
                      <a href="<%= repo.html_url %>" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">
                        <%= repo.full_name %>
                      </a>
                      <% if repo.description.present? %>
                        <p class="text-slate-600 dark:text-slate-400 mt-0.5"><%= repo.description.truncate(60) %></p>
                      <% end %>
                      <div class="flex items-center gap-2 mt-0.5 text-slate-500 dark:text-slate-400">
                        <span>⭐ <%= repo.stargazers_count %></span>
                        <% if repo.language.present? %>
                          <span><%= repo.language %></span>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
      
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Actions / CTAs (owner-only recapture; no raw URLs) -->
        <% if current_user && (current_user.profile_ownerships.exists?(profile_id: @profile.id) rescue false) %>
          <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-4 flex flex-wrap items-center gap-2">
            <%= button_to "Re-capture Screenshots", regenerate_my_profile_path(username: @profile.login), method: :post, class: "inline-flex items-center gap-2 rounded-lg bg-slate-700 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-600" %>
            <%= button_to "Regenerate AI Artwork", regenerate_my_profile_ai_path(username: @profile.login), method: :post, class: "inline-flex items-center gap-2 rounded-lg bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500" %>
          </div>
        <% end %>
        <!-- Profile README -->
        <% if @profile_readme.present? && @profile_readme.content.present? %>
          <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6">
            <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-4">
              Profile README
            </h3>
            <div class="prose dark:prose-invert max-w-none text-sm text-slate-700 dark:text-slate-300">
              <%= render_markdown(@profile_readme.content) %>
            </div>
          </div>
        <% end %>
        
        <!-- Pinned Repositories -->
        <% if @pinned_repositories.present? && @pinned_repositories.any? %>
          <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6">
            <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-4">
              Pinned Repositories
            </h3>
            <div class="grid gap-4 md:grid-cols-2">
              <% @pinned_repositories.each do |repo| %>
                <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-4">
                  <a href="<%= repo.html_url %>" target="_blank" class="font-semibold text-slate-900 dark:text-slate-100 hover:text-blue-600 dark:hover:text-blue-400">
                    <%= repo.name %>
                  </a>
                  <% if repo.description.present? %>
                    <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">
                      <%= repo.description %>
                    </p>
                  <% end %>
                  <div class="flex items-center gap-4 mt-2 text-xs text-slate-500 dark:text-slate-400">
                    <span>⭐ <%= repo.stargazers_count %></span>
                    <% if repo.forks_count && repo.forks_count > 0 %>
                      <span>🔀 <%= repo.forks_count %></span>
                    <% end %>
                    <% if repo.language.present? %>
                      <span><%= repo.language %></span>
                    <% end %>
                  </div>
                  <% if repo.topics.present? && repo.topics.any? %>
                    <div class="flex flex-wrap gap-1 mt-2">
                      <% repo.topics.first(5).each do |topic| %>
                        <span class="text-xs bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 px-2 py-0.5 rounded">
                          <%= topic.name %>
                        </span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Traits & Stats -->
        <% card = @profile.profile_card %>
        <% if card.present? %>
          <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6">
            <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-4">Traits & Stats</h3>
            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <p class="text-sm"><span class="font-semibold">Buff:</span> <%= card.buff.presence || "—" %></p>
                <% if card.buff_description.present? %>
                  <p class="text-sm text-slate-600 dark:text-slate-400"><%= card.buff_description %></p>
                <% end %>
                <p class="text-sm mt-3"><span class="font-semibold">Weakness:</span> <%= card.weakness.presence || "—" %></p>
                <% if card.weakness_description.present? %>
                  <p class="text-sm text-slate-600 dark:text-slate-400"><%= card.weakness_description %></p>
                <% end %>
                <p class="text-sm mt-3"><span class="font-semibold">Vibe:</span> <%= card.vibe.presence || "—" %></p>
                <% if card.vibe_description.present? %>
                  <p class="text-sm text-slate-600 dark:text-slate-400"><%= card.vibe_description %></p>
                <% end %>
                <p class="text-sm mt-3"><span class="font-semibold">Special Move:</span> <%= card.special_move.presence || "—" %></p>
                <% if card.special_move_description.present? %>
                  <p class="text-sm text-slate-600 dark:text-slate-400"><%= card.special_move_description %></p>
                <% end %>
              </div>
              <div>
                <div class="flex gap-4 text-sm">
                  <div><span class="font-semibold">Attack:</span> <%= card.attack %></div>
                  <div><span class="font-semibold">Defense:</span> <%= card.defense %></div>
                  <div><span class="font-semibold">Speed:</span> <%= card.speed %></div>
                </div>
                <p class="text-sm mt-2"><span class="font-semibold">Playing Card:</span> <%= card.playing_card.presence || "—" %></p>
                <p class="text-sm mt-2"><span class="font-semibold">Spirit Animal:</span> <%= card.spirit_animal.presence || "—" %></p>
                <p class="text-sm mt-2"><span class="font-semibold">Archetype:</span> <%= card.archetype.presence || "—" %></p>
                <% if Array(card.tags).any? %>
                  <div class="flex flex-wrap gap-1.5 mt-3">
                    <% Array(card.tags).first(6).each do |t| %>
                      <span class="inline-block rounded-full bg-indigo-100 px-2 py-0.5 text-xs font-medium text-indigo-700 dark:bg-indigo-950 dark:text-indigo-300">#<%= t %></span>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
        
        <!-- Top Repositories -->
        <% if @top_repositories&.any? %>
          <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-6">
            <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-4">
              Top Repositories by Stars
            </h3>
            <div class="space-y-4">
              <% @top_repositories.first(5).each do |repo| %>
              <div class="border-l-4 border-slate-300 dark:border-slate-600 pl-4">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <a href="<%= repo.html_url %>" target="_blank" class="font-semibold text-slate-900 dark:text-slate-100 hover:text-blue-600 dark:hover:text-blue-400">
                      <%= repo.name %>
                    </a>
                    <% if repo.description.present? %>
                      <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">
                        <%= repo.description %>
                      </p>
                    <% end %>
                    <div class="flex items-center gap-4 mt-2 text-xs text-slate-500 dark:text-slate-400">
                      <span>⭐ <%= repo.stargazers_count %></span>
                      <% if repo.forks_count && repo.forks_count > 0 %>
                        <span>🔀 <%= repo.forks_count %></span>
                      <% end %>
                      <% if repo.language.present? %>
                        <span><%= repo.language %></span>
                      <% end %>
                    </div>
                  </div>
                </div>
                <% if repo.topics.present? && repo.topics.any? %>
                  <div class="flex flex-wrap gap-2 mt-2">
                    <% repo.topics.each do |topic| %>
                      <span class="text-xs bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 px-2 py-1 rounded">
                        <%= topic.name %>
                      </span>
                    <% end %>
                  </div>
                <% end %>
              </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-6">
      <p class="text-yellow-800 dark:text-yellow-200">
        No profile data available. Please check the logs for errors.
      </p>
    </div>
  <% end %>
</section>
