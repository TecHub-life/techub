<%# Page metadata for sharing %>
<%
  title_text = (@profile&.display_name.presence || @profile&.login || params[:username]).to_s
  desc_text = @profile&.bio.presence || "GitHub profile insights and AI trading card"
  content_for :title, "#{title_text} â€“ TecHub"
  content_for :description, desc_text

  og_url = nil
  begin
    if @profile
      og_asset = @profile.profile_assets.find_by(kind: "og")
      if og_asset&.public_url.present?
        og_url = og_asset.public_url
      else
        base = Rails.root.join("public", "generated", @profile.login)
        rel = nil
        if File.exist?(base.join("og.jpg"))
          rel = "/generated/#{@profile.login}/og.jpg"
        elsif File.exist?(base.join("og.png"))
          rel = "/generated/#{@profile.login}/og.png"
        end
        og_url = rel.present? ? (request.base_url + rel) : nil
      end
    end
  rescue StandardError
    og_url = nil
  end
  content_for :og_image, og_url if og_url.present?
  content_for :twitter_image, og_url if og_url.present?
%>

<%# JSON-LD Structured Data for Profile %>
<% if @profile.present? %>
  <% json_ld = {
    "@context" => "https://schema.org",
    "@type" => "Person",
    "name" => @profile.display_name,
    "url" => request.original_url,
    "image" => @profile.avatar_url,
    "description" => (@profile.profile_card&.short_bio.presence || @profile.bio).to_s,
    "sameAs" => [@profile.html_url, (@profile.blog if @profile.blog.present?)].compact,
    "additionalProperty" => [
      { "@type" => "PropertyValue", "name" => "attack", "value" => @profile.profile_card&.attack },
      { "@type" => "PropertyValue", "name" => "defense", "value" => @profile.profile_card&.defense },
      { "@type" => "PropertyValue", "name" => "speed", "value" => @profile.profile_card&.speed },
      { "@type" => "PropertyValue", "name" => "playing_card", "value" => @profile.profile_card&.playing_card },
      { "@type" => "PropertyValue", "name" => "spirit_animal", "value" => @profile.profile_card&.spirit_animal },
      { "@type" => "PropertyValue", "name" => "archetype", "value" => @profile.profile_card&.archetype }
    ]
  } %>
  <script type="application/ld+json">
    <%= json_escape(json_ld.to_json) %>
  </script>
<% end %>

<section class="mx-auto max-w-6xl px-4 py-8">
  <% if @profile.present? %>
    <%# TABBED CONTENT SECTION %>
    <div class="mb-6" data-controller="tabs" data-tabs-default-value="profile">
      <%# Tab Navigation - Sticky, Centered with larger text/icons on desktop %>
      <nav class="sticky top-[60px] z-40 -mb-px grid grid-cols-3 place-items-center md:flex md:justify-center lg:justify-around gap-2 sm:gap-3 md:gap-4 lg:gap-6 overflow-x-auto scrollbar-hide bg-slate-100/95 dark:bg-slate-900/95 backdrop-blur-sm shadow-sm border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2" aria-label="Tabs">
        <button data-tabs-target="tab" data-tab-name="profile" data-action="click->tabs#change" class="cursor-pointer whitespace-nowrap border-b-2 px-2 py-2 text-xs sm:text-sm lg:text-base font-medium transition flex items-center gap-1 sm:gap-2 border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300">
          <svg class="h-4 w-4 lg:h-5 lg:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
          <span>Profile</span>
        </button>
        <button data-tabs-target="tab" data-tab-name="overview" data-action="click->tabs#change" class="cursor-pointer whitespace-nowrap border-b-2 px-2 py-2 text-xs sm:text-sm lg:text-base font-medium transition flex items-center gap-1 sm:gap-2 border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300">
          <svg class="h-4 w-4 lg:h-5 lg:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <span>Overview</span>
        </button>
        <button data-tabs-target="tab" data-tab-name="cards" data-action="click->tabs#change" class="cursor-pointer whitespace-nowrap border-b-2 px-2 py-2 text-xs sm:text-sm lg:text-base font-medium transition flex items-center gap-1 sm:gap-2 border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300">
          <svg class="h-4 w-4 lg:h-5 lg:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
          </svg>
          <span>Cards</span>
        </button>
        <button data-tabs-target="tab" data-tab-name="repos" data-action="click->tabs#change" class="cursor-pointer whitespace-nowrap border-b-2 px-2 py-2 text-xs sm:text-sm lg:text-base font-medium transition flex items-center gap-1 sm:gap-2 border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300">
          <svg class="h-4 w-4 lg:h-5 lg:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
          </svg>
          <span>Repositories</span>
        </button>
        <button data-tabs-target="tab" data-tab-name="activity" data-action="click->tabs#change" class="cursor-pointer whitespace-nowrap border-b-2 px-2 py-2 text-xs sm:text-sm lg:text-base font-medium transition flex items-center gap-1 sm:gap-2 border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300">
          <svg class="h-4 w-4 lg:h-5 lg:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          <span>Activity</span>
        </button>
        <button data-tabs-target="tab" data-tab-name="stats" data-action="click->tabs#change" class="cursor-pointer whitespace-nowrap border-b-2 px-2 py-2 text-xs sm:text-sm lg:text-base font-medium transition flex items-center gap-1 sm:gap-2 border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300">
          <svg class="h-4 w-4 lg:h-5 lg:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <span>Stats & Traits</span>
        </button>
      </nav>

      <%# Tab Content %>
      <div class="mt-6">
        <%# Profile Tab (Hero) - Default %>
        <div data-tabs-target="panel" data-tab-panel="profile">
          <%= render partial: 'profiles/tabs/hero', locals: { 
            profile: @profile
          } %>
        </div>

        <%# Overview Tab %>
        <div data-tabs-target="panel" data-tab-panel="overview" class="hidden">
          <%= render partial: 'profiles/tabs/overview', locals: { 
            profile: @profile, 
            languages: @languages,
            social_accounts: @social_accounts,
            organizations: @organizations
          } %>
        </div>

        <%# Cards Tab %>
        <div data-tabs-target="panel" data-tab-panel="cards" class="hidden">
          <%= render partial: 'profiles/tabs/cards', locals: { 
            profile: @profile
          } %>
        </div>

        <%# Repositories Tab %>
        <div data-tabs-target="panel" data-tab-panel="repos" class="hidden">
          <%= render partial: 'profiles/tabs/repositories', locals: { 
            profile: @profile,
            pinned_repositories: @pinned_repositories,
            top_repositories: @top_repositories
          } %>
        </div>

        <%# Activity Tab %>
        <div data-tabs-target="panel" data-tab-panel="activity" class="hidden">
          <%= render partial: 'profiles/tabs/activity', locals: { 
            profile: @profile,
            recent_activity: @recent_activity,
            active_repositories: @active_repositories
          } %>
        </div>

        <%# Stats & Traits Tab %>
        <div data-tabs-target="panel" data-tab-panel="stats" class="hidden">
          <%= render partial: 'profiles/tabs/stats', locals: { 
            profile: @profile
          } %>
        </div>
      </div>
    </div>

  <% else %>
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-6">
      <p class="text-yellow-800 dark:text-yellow-200">
        No profile data available. Please check the logs for errors.
      </p>
    </div>
  <% end %>
</section>
