<%# Page metadata for sharing %>
<%
  title_text = (@profile&.display_name.presence || @profile&.login || params[:username]).to_s
  desc_text = @profile&.bio.presence || "GitHub profile insights and AI trading card"
  content_for :title, "#{title_text} â€“ TecHub"
  content_for :description, desc_text
  og_kind = @profile&.preferred_og_kind || "og"
  og_url = @profile ? profile_asset_url(@profile, og_kind, fallback_basename: og_kind, absolute: true) : nil
  if og_url.present?
    content_for :og_image, og_url
    content_for :twitter_image, og_url

    secure_url = og_url.start_with?("http://") ? og_url.sub(/\Ahttp:/, "https:") : og_url
    og_mime = begin
      ext = URI.parse(og_url).path
      case File.extname(ext).downcase
      when ".png" then "image/png"
      when ".webp" then "image/webp"
      when ".gif" then "image/gif"
      else "image/jpeg"
      end
    rescue URI::InvalidURIError
      nil
    end

    extra_tags = []
    extra_tags << tag.meta(property: "og:image:secure_url", content: secure_url) if secure_url.present?
    extra_tags << tag.meta(property: "og:image:type", content: og_mime) if og_mime.present?

    content_for :head, safe_join(extra_tags) if extra_tags.any?
  end
%>

<%# JSON-LD Structured Data for Profile %>
<% if @profile.present? %>
  <% json_ld = {
    "@context" => "https://schema.org",
    "@type" => "Person",
    "name" => @profile.display_name,
    "url" => request.original_url,
    "image" => @profile.avatar_url,
    "description" => (@profile.profile_card&.short_bio.presence || @profile.bio).to_s,
    "sameAs" => [@profile.html_url, (@profile.blog if @profile.blog.present?)].compact,
    "additionalProperty" => [
      { "@type" => "PropertyValue", "name" => "attack", "value" => @profile.profile_card&.attack },
      { "@type" => "PropertyValue", "name" => "defense", "value" => @profile.profile_card&.defense },
      { "@type" => "PropertyValue", "name" => "speed", "value" => @profile.profile_card&.speed },
      { "@type" => "PropertyValue", "name" => "playing_card", "value" => @profile.profile_card&.playing_card },
      { "@type" => "PropertyValue", "name" => "spirit_animal", "value" => @profile.profile_card&.spirit_animal },
      { "@type" => "PropertyValue", "name" => "archetype", "value" => @profile.profile_card&.archetype }
    ]
  } %>
  <script type="application/ld+json">
    <%= json_escape(json_ld.to_json) %>
  </script>
<% end %>

<section class="mx-auto max-w-6xl px-4 py-8" data-controller="hidden-items" data-hidden-items-hidden-count-value="<%= @hidden_showcase_count %>" data-hidden-items-analytics-endpoint-value="<%= analytics_showcase_path(format: :json) %>" data-hidden-items-profile-value="<%= @profile.login %>">
  <% if @profile.present? %>
    <%# TABBED CONTENT SECTION %>
    <div class="mb-6" data-controller="tabs" data-tabs-default-value="profile">
      <%# Tab Navigation - Sticky, Centered with larger text/icons on desktop %>
      <nav class="sticky top-[60px] z-40 -mb-px grid grid-cols-3 place-items-center gap-2 overflow-x-auto rounded-xl border border-slate-200 bg-slate-100/95 px-4 py-2 text-sm shadow-sm backdrop-blur dark:border-slate-700 dark:bg-slate-900/95 md:flex md:justify-center md:gap-4 lg:gap-6" role="tablist" aria-label="Profile sections">
        <button
          type="button"
          id="tab-profile"
          data-tabs-target="tab"
          data-tabs-id="profile"
          data-action="tabs#select"
          class="flex cursor-pointer items-center gap-2 whitespace-nowrap rounded-lg px-3 py-2 font-medium text-slate-500 transition hover:bg-slate-100 hover:text-slate-700 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-200"
          role="tab"
          aria-selected="false"
          aria-controls="tab-panel-profile">
          <svg class="h-4 w-4 lg:h-5 lg:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
          <span>Profile</span>
        </button>
        <button
          type="button"
          id="tab-overview"
          data-tabs-target="tab"
          data-tabs-id="overview"
          data-action="tabs#select"
          class="flex cursor-pointer items-center gap-2 whitespace-nowrap rounded-lg px-3 py-2 font-medium text-slate-500 transition hover:bg-slate-100 hover:text-slate-700 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-200"
          role="tab"
          aria-selected="false"
          aria-controls="tab-panel-overview">
          <svg class="h-4 w-4 lg:h-5 lg:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <span>Overview</span>
        </button>
        <button
          type="button"
          id="tab-cards"
          data-tabs-target="tab"
          data-tabs-id="cards"
          data-action="tabs#select"
          class="flex cursor-pointer items-center gap-2 whitespace-nowrap rounded-lg px-3 py-2 font-medium text-slate-500 transition hover:bg-slate-100 hover:text-slate-700 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-200"
          role="tab"
          aria-selected="false"
          aria-controls="tab-panel-cards">
          <svg class="h-4 w-4 lg:h-5 lg:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
          </svg>
          <span>Cards</span>
        </button>
        <button
          type="button"
          id="tab-repos"
          data-tabs-target="tab"
          data-tabs-id="repos"
          data-action="tabs#select"
          class="flex cursor-pointer items-center gap-2 whitespace-nowrap rounded-lg px-3 py-2 font-medium text-slate-500 transition hover:bg-slate-100 hover:text-slate-700 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-200"
          role="tab"
          aria-selected="false"
          aria-controls="tab-panel-repos">
          <svg class="h-4 w-4 lg:h-5 lg:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
          </svg>
          <span>Repositories</span>
        </button>
        <button
          type="button"
          id="tab-activity"
          data-tabs-target="tab"
          data-tabs-id="activity"
          data-action="tabs#select"
          class="flex cursor-pointer items-center gap-2 whitespace-nowrap rounded-lg px-3 py-2 font-medium text-slate-500 transition hover:bg-slate-100 hover:text-slate-700 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-200"
          role="tab"
          aria-selected="false"
          aria-controls="tab-panel-activity">
          <svg class="h-4 w-4 lg:h-5 lg:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          <span>Activity</span>
        </button>
        <button
          type="button"
          id="tab-stats"
          data-tabs-target="tab"
          data-tabs-id="stats"
          data-action="tabs#select"
          class="flex cursor-pointer items-center gap-2 whitespace-nowrap rounded-lg px-3 py-2 font-medium text-slate-500 transition hover:bg-slate-100 hover:text-slate-700 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-200"
          role="tab"
          aria-selected="false"
          aria-controls="tab-panel-stats">
          <svg class="h-4 w-4 lg:h-5 lg:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <span>Stats & Traits</span>
        </button>
      </nav>

      <%# Tab Content %>
      <div class="mt-6">
        <%# Profile Tab (Hero) - Default %>
        <section
          id="tab-panel-profile"
          data-tabs-target="panel"
          data-tabs-id="profile"
          role="tabpanel"
          aria-labelledby="tab-profile">
          <%= render partial: 'profiles/tabs/hero', locals: { 
            profile: @profile,
            pinned_items: @pinned_showcase_items,
            preferences: @profile_preferences,
            hidden_count: @hidden_showcase_count
          } %>
        </section>

        <%# Overview Tab %>
        <section
          id="tab-panel-overview"
          data-tabs-target="panel"
          data-tabs-id="overview"
          class="hidden"
          role="tabpanel"
          aria-labelledby="tab-overview"
          tabindex="0">
          <%= render partial: 'profiles/tabs/overview', locals: { 
            profile: @profile, 
            languages: @languages,
            social_accounts: @social_accounts,
            organizations: @organizations,
            links: @profile_links,
            achievements: @profile_achievements,
            experiences: @profile_experiences,
            preferences: @profile_preferences,
            hidden_count: @hidden_showcase_count
          } %>
        </section>

        <%# Cards Tab %>
        <section
          id="tab-panel-cards"
          data-tabs-target="panel"
          data-tabs-id="cards"
          class="hidden"
          role="tabpanel"
          aria-labelledby="tab-cards"
          tabindex="0">
          <%= render partial: 'profiles/tabs/cards', locals: { 
            profile: @profile
          } %>
        </section>

        <%# Repositories Tab %>
        <section
          id="tab-panel-repos"
          data-tabs-target="panel"
          data-tabs-id="repos"
          class="hidden"
          role="tabpanel"
          aria-labelledby="tab-repos"
          tabindex="0">
          <%= render partial: 'profiles/tabs/repositories', locals: { 
            profile: @profile,
            pinned_repositories: @pinned_repositories,
            top_repositories: @top_repositories
          } %>
        </section>

        <%# Activity Tab %>
        <section
          id="tab-panel-activity"
          data-tabs-target="panel"
          data-tabs-id="activity"
          class="hidden"
          role="tabpanel"
          aria-labelledby="tab-activity"
          tabindex="0">
          <%= render partial: 'profiles/tabs/activity', locals: { 
            profile: @profile,
            recent_activity: @recent_activity,
            active_repositories: @active_repositories
          } %>
        </section>

        <%# Stats & Traits Tab %>
        <section
          id="tab-panel-stats"
          data-tabs-target="panel"
          data-tabs-id="stats"
          class="hidden"
          role="tabpanel"
          aria-labelledby="tab-stats"
          tabindex="0">
          <%= render partial: 'profiles/tabs/stats', locals: { 
            profile: @profile
          } %>
        </section>
      </div>
    </div>

  <% else %>
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-6">
      <p class="text-yellow-800 dark:text-yellow-200">
        No profile data available. Please check the logs for errors.
      </p>
    </div>
  <% end %>
</section>
