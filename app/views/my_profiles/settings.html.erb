<section class="mx-auto max-w-6xl space-y-6 px-4 py-12">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-slate-900 dark:text-slate-100">Settings – @<%= @profile.login %></h1>
      <% if @profile.last_pipeline_status.present? %>
        <span class="inline-block mt-2 text-xs px-2 py-1 rounded border
          <%= case @profile.last_pipeline_status
             when 'queued' then 'bg-yellow-50 border-yellow-200 text-yellow-800 dark:bg-yellow-900/20 dark:border-yellow-800 dark:text-yellow-200'
             when 'success' then 'bg-green-50 border-green-200 text-green-800 dark:bg-green-900/20 dark:border-green-800 dark:text-green-200'
             when 'failure' then 'bg-red-50 border-red-200 text-red-800 dark:bg-red-900/20 dark:border-red-800 dark:text-red-200'
             else 'bg-slate-100 border-slate-200 text-slate-700 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300' end %>
        "><%= @profile.last_pipeline_status.capitalize %></span>
      <% end %>
      <% if @profile.last_pipeline_error.present? %>
        <p class="mt-2 text-sm text-red-600 dark:text-red-400"><%= @profile.last_pipeline_error %></p>
      <% end %>
    </div>
    <div class="flex items-center gap-2">
      <%= link_to "Back", my_profiles_path, class: "rounded border px-3 py-1.5 text-slate-700 hover:bg-slate-50 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-800" %>
      <%= link_to "API Docs", "/api-docs", target: "_blank", class: "rounded border px-3 py-1.5 text-slate-700 hover:bg-slate-50 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-800" %>
    </div>
  </div>

  <div class="grid gap-6 md:grid-cols-3">
    <!-- Sidebar: Owned Profiles -->
    <aside class="md:col-span-1 rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
      <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-3">Your Profiles</h2>
      <% owned = current_user&.profiles&.order(:login) || [] %>
      <% if owned.any? %>
        <ul class="space-y-1 text-sm">
          <% owned.each do |p| %>
            <li>
              <a href="<%= my_profile_settings_path(username: p.login) %>" class="text-blue-600 hover:text-blue-800 dark:text-blue-400">
                @<%= p.login %>
              </a>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="text-slate-600 dark:text-slate-300 text-sm">No profiles yet.</p>
      <% end %>
      <div class="mt-3">
        <a href="<%= my_profiles_path %>" class="inline-block text-sm text-slate-700 hover:text-blue-600 dark:text-slate-300">Manage all</a>
      </div>
    </aside>

    <!-- Main: Actions and Assets -->
    <div class="md:col-span-2 space-y-6">
      <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-3">Avatar Selection</h2>
        <form action="<%= update_my_profile_settings_path(username: @profile.login) %>" method="post" class="space-y-2">
          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          <% choice = @profile.profile_card&.avatar_choice || 'real' %>
          <div class="flex items-center gap-4 text-sm">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="avatar_choice" value="real" <%= 'checked' if choice == 'real' %> class="h-4 w-4 text-blue-600 focus:ring-blue-500">
              <span class="text-slate-700 dark:text-slate-300">Use my GitHub photo</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="avatar_choice" value="ai" <%= 'checked' if choice == 'ai' %> class="h-4 w-4 text-blue-600 focus:ring-blue-500">
              <span class="text-slate-700 dark:text-slate-300">Use fun AI photo</span>
            </label>
          </div>
          <button class="mt-2 rounded border px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-800">Save avatar choice</button>
        </form>
      </div>
      <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-3">Background Selection</h2>
        <p class="text-sm text-slate-600 dark:text-slate-300 mb-3">Choose how backgrounds render for Card, OG, and Simple. Options: AI (latest), Default image, or a solid color.</p>
        <form action="<%= update_my_profile_settings_path(username: @profile.login) %>" method="post" class="space-y-3">
          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          <div class="flex items-center gap-2">
            <input id="apply_everywhere" type="checkbox" name="apply_everywhere" value="1" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
            <label for="apply_everywhere" class="text-sm text-slate-700 dark:text-slate-300">Use these background settings for all card types</label>
          </div>
          <div class="grid gap-3 sm:grid-cols-3">
            <div>
              <label class="block text-sm font-medium mb-1">Card background</label>
              <select name="bg_choice_card" class="w-full rounded border border-slate-300 bg-white p-2 text-slate-900 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100">
                <% sel = @profile.profile_card&.bg_choice_card || 'ai' %>
                <option value="ai" <%= 'selected' if sel == 'ai' %>>AI (latest)</option>
                <option value="default" <%= 'selected' if sel == 'default' %>>Default image</option>
                <option value="color" <%= 'selected' if sel == 'color' %>>Solid color</option>
              </select>
              <input type="color" name="bg_color_card" value="<%= @profile.profile_card&.bg_color_card || '#0f172a' %>" class="mt-2 h-9 w-16 rounded border border-slate-300 dark:border-slate-600" title="Card color">
              <div class="mt-2 grid grid-cols-3 gap-2 text-xs">
                <div>
                  <label class="block">Crop X</label>
                  <input type="number" step="0.01" min="0" max="1" name="bg_fx_card" value="<%= @profile.profile_card&.bg_fx_card || 0.5 %>" class="w-full rounded border border-slate-300 px-2 py-1 dark:border-slate-600">
                </div>
                <div>
                  <label class="block">Crop Y</label>
                  <input type="number" step="0.01" min="0" max="1" name="bg_fy_card" value="<%= @profile.profile_card&.bg_fy_card || 0.5 %>" class="w-full rounded border border-slate-300 px-2 py-1 dark:border-slate-600">
                </div>
                <div>
                  <label class="block">Zoom</label>
                  <input type="number" step="0.01" min="0.5" max="3" name="bg_zoom_card" value="<%= @profile.profile_card&.bg_zoom_card || 1.0 %>" class="w-full rounded border border-slate-300 px-2 py-1 dark:border-slate-600">
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">OG background</label>
              <select name="bg_choice_og" class="w-full rounded border border-slate-300 bg-white p-2 text-slate-900 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100">
                <% sel = @profile.profile_card&.bg_choice_og || 'ai' %>
                <option value="ai" <%= 'selected' if sel == 'ai' %>>AI (latest)</option>
                <option value="default" <%= 'selected' if sel == 'default' %>>Default image</option>
                <option value="color" <%= 'selected' if sel == 'color' %>>Solid color</option>
              </select>
              <input type="color" name="bg_color_og" value="<%= @profile.profile_card&.bg_color_og || '#0f172a' %>" class="mt-2 h-9 w-16 rounded border border-slate-300 dark:border-slate-600" title="OG color">
              <div class="mt-2 grid grid-cols-3 gap-2 text-xs">
                <div>
                  <label class="block">Crop X</label>
                  <input type="number" step="0.01" min="0" max="1" name="bg_fx_og" value="<%= @profile.profile_card&.bg_fx_og || 0.5 %>" class="w-full rounded border border-slate-300 px-2 py-1 dark:border-slate-600">
                </div>
                <div>
                  <label class="block">Crop Y</label>
                  <input type="number" step="0.01" min="0" max="1" name="bg_fy_og" value="<%= @profile.profile_card&.bg_fy_og || 0.5 %>" class="w-full rounded border border-slate-300 px-2 py-1 dark:border-slate-600">
                </div>
                <div>
                  <label class="block">Zoom</label>
                  <input type="number" step="0.01" min="0.5" max="3" name="bg_zoom_og" value="<%= @profile.profile_card&.bg_zoom_og || 1.0 %>" class="w-full rounded border border-slate-300 px-2 py-1 dark:border-slate-600">
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Simple background</label>
              <select name="bg_choice_simple" class="w-full rounded border border-slate-300 bg-white p-2 text-slate-900 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100">
                <% sel = @profile.profile_card&.bg_choice_simple || 'ai' %>
                <option value="ai" <%= 'selected' if sel == 'ai' %>>AI (latest)</option>
                <option value="default" <%= 'selected' if sel == 'default' %>>Default image</option>
                <option value="color" <%= 'selected' if sel == 'color' %>>Solid color</option>
              </select>
              <input type="color" name="bg_color_simple" value="<%= @profile.profile_card&.bg_color_simple || '#0f172a' %>" class="mt-2 h-9 w-16 rounded border border-slate-300 dark:border-slate-600" title="Simple color">
              <div class="mt-2 grid grid-cols-3 gap-2 text-xs">
                <div>
                  <label class="block">Crop X</label>
                  <input type="number" step="0.01" min="0" max="1" name="bg_fx_simple" value="<%= @profile.profile_card&.bg_fx_simple || 0.5 %>" class="w-full rounded border border-slate-300 px-2 py-1 dark:border-slate-600">
                </div>
                <div>
                  <label class="block">Crop Y</label>
                  <input type="number" step="0.01" min="0" max="1" name="bg_fy_simple" value="<%= @profile.profile_card&.bg_fy_simple || 0.5 %>" class="w-full rounded border border-slate-300 px-2 py-1 dark:border-slate-600">
                </div>
                <div>
                  <label class="block">Zoom</label>
                  <input type="number" step="0.01" min="0.5" max="3" name="bg_zoom_simple" value="<%= @profile.profile_card&.bg_zoom_simple || 1.0 %>" class="w-full rounded border border-slate-300 px-2 py-1 dark:border-slate-600">
                </div>
              </div>
            </div>
          </div>
          <div>
            <button class="rounded bg-slate-900 px-4 py-2 text-white dark:bg-slate-100 dark:text-slate-900">Save Backgrounds</button>
          </div>
        </form>
      </div>

      <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800 space-y-3">
        <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Regenerate</h2>
        <div class="grid gap-3 sm:grid-cols-2">
          <div>
            <p class="text-sm text-slate-600 dark:text-slate-300 mb-2">Re-capture screenshots and optimize. No AI cost.</p>
            <%= button_to "Re-capture Screenshots", regenerate_my_profile_path(username: @profile.login), method: :post, class: "w-full rounded bg-slate-900 px-4 py-2 text-white dark:bg-slate-100 dark:text-slate-900" %>
          </div>
          <div>
            <% available = Time.current >= (@ai_regen_available_at || Time.at(0)) %>
            <p class="text-sm text-slate-600 dark:text-slate-300 mb-2">Regenerate AI artwork (weekly limit)</p>
            <%= button_to "Regenerate AI Artwork", regenerate_my_profile_ai_path(username: @profile.login), method: :post,
              class: "w-full rounded px-4 py-2 text-white #{available ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-slate-500 cursor-not-allowed'}",
              disabled: !available %>
            <% unless available %>
              <% remaining = (@ai_regen_available_at - Time.current).to_i %>
              <% hrs = (remaining / 3600).floor %>
              <% mins = ((remaining % 3600) / 60).floor %>
              <p class="mt-1 text-xs text-slate-500">Try again in ~<%= hrs %>h <%= mins %>m (after <%= @ai_regen_available_at.strftime('%b %d, %Y %H:%M') %>)</p>
            <% end %>
          </div>
        </div>
      </div>

      <div class="grid gap-6 md:grid-cols-3">
        <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
          <h3 class="font-medium text-slate-900 dark:text-slate-100 mb-2">OG</h3>
          <% if @asset_og&.public_url.present? %>
            <a href="<%= @asset_og.public_url %>" target="_blank" class="text-blue-600 dark:text-blue-400">View</a>
          <% else %>
            <a href="<%= og_image_path(login: @profile.login) %>" target="_blank" class="text-blue-600 dark:text-blue-400">Generate/Fetch</a>
          <% end %>
          <div class="mt-3">
            <form action="<%= upload_my_profile_asset_path(username: @profile.login) %>" method="post" enctype="multipart/form-data">
              <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
              <input type="hidden" name="kind" value="og">
              <input type="file" name="file" accept="image/*" class="block w-full text-sm text-slate-700 dark:text-slate-300">
              <button class="mt-2 rounded border px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-800">Upload custom</button>
            </form>
          </div>
        </div>
        <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
          <h3 class="font-medium text-slate-900 dark:text-slate-100 mb-2">Card</h3>
          <div class="flex items-start gap-3">
            <div class="shrink-0">
              <div class="relative w-[320px] h-[180px] overflow-hidden rounded border border-slate-200 bg-slate-900 dark:border-slate-700">
                <iframe src="<%= card_preview_path(login: @profile.login) %>" title="Card preview" style="width:1280px; height:720px; transform:scale(0.25); transform-origin: top left; border:0;" loading="lazy"></iframe>
              </div>
              <div class="mt-2">
                <a href="<%= card_preview_path(login: @profile.login) %>" target="_blank" class="text-sm text-blue-600 hover:underline dark:text-blue-400">Open full view</a>
              </div>
            </div>
            <div class="flex-1">
              <% if @asset_card&.public_url.present? %>
                <a href="<%= @asset_card.public_url %>" target="_blank" class="text-blue-600 dark:text-blue-400">Custom image</a>
              <% else %>
                <span class="text-slate-600 dark:text-slate-300 text-sm">Using generated background</span>
              <% end %>
              <div class="mt-3">
                <form action="<%= upload_my_profile_asset_path(username: @profile.login) %>" method="post" enctype="multipart/form-data">
                  <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                  <input type="hidden" name="kind" value="card">
                  <input type="file" name="file" accept="image/*" class="block w-full text-sm text-slate-700 dark:text-slate-300">
                  <button class="mt-2 rounded border px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-800">Upload custom</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
          <h3 class="font-medium text-slate-900 dark:text-slate-100 mb-2">OG</h3>
          <div class="flex items-start gap-3">
            <div class="shrink-0">
              <div class="relative w-[300px] h-[158px] overflow-hidden rounded border border-slate-200 bg-slate-900 dark:border-slate-700">
                <iframe src="<%= card_og_path(login: @profile.login) %>" title="OG preview" style="width:1200px; height:630px; transform:scale(0.25); transform-origin: top left; border:0;" loading="lazy"></iframe>
              </div>
              <div class="mt-2">
                <a href="<%= card_og_path(login: @profile.login) %>" target="_blank" class="text-sm text-blue-600 hover:underline dark:text-blue-400">Open full view</a>
              </div>
            </div>
            <div class="flex-1">
              <% if @asset_og&.public_url.present? %>
                <a href="<%= @asset_og.public_url %>" target="_blank" class="text-blue-600 dark:text-blue-400">Custom image</a>
              <% else %>
                <span class="text-slate-600 dark:text-slate-300 text-sm">Using generated background</span>
              <% end %>
              <div class="mt-3">
                <form action="<%= upload_my_profile_asset_path(username: @profile.login) %>" method="post" enctype="multipart/form-data">
                  <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                  <input type="hidden" name="kind" value="og">
                  <input type="file" name="file" accept="image/*" class="block w-full text-sm text-slate-700 dark:text-slate-300">
                  <button class="mt-2 rounded border px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-800">Upload custom</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
          <h3 class="font-medium text-slate-900 dark:text-slate-100 mb-2">Simple</h3>
          <div class="flex items-start gap-3">
            <div class="shrink-0">
              <div class="relative w-[320px] h-[180px] overflow-hidden rounded border border-slate-200 bg-slate-900 dark:border-slate-700">
                <iframe src="<%= card_simple_path(login: @profile.login) %>" title="Simple preview" style="width:1280px; height:720px; transform:scale(0.25); transform-origin: top left; border:0;" loading="lazy"></iframe>
              </div>
              <div class="mt-2">
                <a href="<%= card_simple_path(login: @profile.login) %>" target="_blank" class="text-sm text-blue-600 hover:underline dark:text-blue-400">Open full view</a>
              </div>
            </div>
            <div class="flex-1">
              <% if @asset_simple&.public_url.present? %>
                <a href="<%= @asset_simple.public_url %>" target="_blank" class="text-blue-600 dark:text-blue-400">Custom image</a>
              <% else %>
                <span class="text-slate-600 dark:text-slate-300 text-sm">Using generated background</span>
              <% end %>
              <div class="mt-3">
                <form action="<%= upload_my_profile_asset_path(username: @profile.login) %>" method="post" enctype="multipart/form-data">
                  <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                  <input type="hidden" name="kind" value="simple">
                  <input type="file" name="file" accept="image/*" class="block w-full text-sm text-slate-700 dark:text-slate-300">
                  <button class="mt-2 rounded border px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-800">Upload custom</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <h3 class="font-medium text-slate-900 dark:text-slate-100 mb-2">Banner (3×1)</h3>
        <p class="text-sm text-slate-600 dark:text-slate-300">Ultra-wide banner used for future card layouts; upload to override AI output.</p>
        <form action="<%= upload_my_profile_asset_path(username: @profile.login) %>" method="post" enctype="multipart/form-data" class="mt-2">
          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          <input type="hidden" name="kind" value="avatar_3x1">
          <input type="file" name="file" accept="image/*" class="block w-full text-sm text-slate-700 dark:text-slate-300">
          <button class="mt-2 rounded border px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-800">Upload banner</button>
        </form>
      </div>

      <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
        <h3 class="font-medium text-slate-900 dark:text-slate-100 mb-2">Your AI Asset Library</h3>
        <p class="text-sm text-slate-600 dark:text-slate-300 mb-3">Pick a previously generated asset as the active image.</p>
        <% base = Rails.root.join('public','generated', @profile.login) %>
        <% gallery = Dir.exist?(base) ? Dir[base.join('*.{jpg,jpeg,png}').to_s] : [] %>
        <% if gallery.any? %>
          <div class="grid gap-3 sm:grid-cols-3">
            <% gallery.first(12).each do |path| %>
              <% fname = File.basename(path) %>
              <div class="rounded border border-slate-200 p-2 dark:border-slate-700">
                <img src="<%= "/generated/#{@profile.login}/#{fname}" %>" alt="<%= fname %>" class="h-24 w-full object-cover rounded">
                <div class="mt-2 flex items-center justify-between gap-2 text-xs">
                  <span class="truncate" title="<%= fname %>"><%= fname %></span>
                  <form action="<%= select_my_profile_asset_path(username: @profile.login) %>" method="post" class="flex items-center gap-1">
                    <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                    <input type="hidden" name="local_path" value="<%= path %>">
                    <select name="kind" class="rounded border border-slate-300 bg-white px-1 py-0.5 dark:border-slate-700 dark:bg-slate-900">
                      <option value="og">OG</option>
                      <option value="card">Card</option>
                      <option value="simple">Simple</option>
                      <option value="avatar_3x1">Banner 3×1</option>
                      <option value="avatar_16x9">16×9</option>
                      <option value="avatar_1x1">1×1</option>
                    </select>
                    <button class="rounded border px-2 py-0.5 dark:border-slate-700">Use</button>
                  </form>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-slate-600 dark:text-slate-300">No generated assets yet. Regenerate AI artwork to add items.</p>
        <% end %>
      </div>
    </div>
  </div>
</section>
