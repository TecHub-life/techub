<%# Backgrounds Tab %>
<div class="space-y-6">
  <% uploads_enabled = defined?(Storage::ActiveStorageUploadService) %>
  <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-lg transition dark:border-slate-700 dark:bg-slate-900 md:p-6">
    <% card = profile.profile_card %>
    <% choice_attr = :bg_choice_card %>
    <% color_attr  = :bg_color_card %>
    <% fx_attr     = :bg_fx_card %>
    <% fy_attr     = :bg_fy_card %>
    <% zoom_attr   = :bg_zoom_card %>
    <% library_value = bg_library_path_for(profile, :card) %>
    <% selected = card&.public_send(choice_attr) || "library" %>
    <% saved_preview_url = supporting_art_url_for(profile: profile, aspect: :card) %>
    <% supporting_status = supporting_art_source_label(profile, :card) %>
    <% card_asset = profile.profile_assets.find_by(kind: "card") %>
    <% live_card_url = profile_asset_url(profile, "card", fallback_basename: "card") %>
    <% live_card_url = saved_preview_url if live_card_url.blank? %>

    <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
      <div>
        <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100">Supporting art</h2>
        <p class="text-sm text-slate-600 dark:text-slate-300">Pick one background (library, upload, or colour) and we’ll reuse it for OG, Card, Card Pro, Simple, square crops, leaderboard art, and X profile graphics.</p>
      </div>
    </div>

    <div class="mt-4 grid gap-4 lg:grid-cols-2">
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-800">
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Live in cards</p>
        <div class="mt-2 overflow-hidden rounded-xl border border-slate-200 bg-slate-100 dark:border-slate-600 dark:bg-slate-900">
          <img src="<%= live_card_url %>" alt="Current card screenshot" class="h-44 w-full object-cover" loading="lazy">
        </div>
        <p class="mt-3 text-sm font-semibold text-slate-900 dark:text-slate-100">
          Latest screenshot
          <% if card_asset&.generated_at.present? %>
            · captured <%= time_ago_in_words(card_asset.generated_at) %> ago
          <% end %>
        </p>
        <p class="text-xs text-slate-500 dark:text-slate-400">
          Live screenshots refresh automatically every ~3 hours (Refresh Stale job) or instantly when you click "Re-capture screenshots".
        </p>
      </div>
      <div class="rounded-2xl border border-indigo-200 bg-indigo-50/70 p-4 text-sm text-slate-900 dark:border-indigo-900/60 dark:bg-indigo-950/40 dark:text-slate-100">
        <p class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-300">Saved supporting art</p>
        <div class="mt-2 overflow-hidden rounded-xl border border-slate-200 bg-slate-100 dark:border-slate-600 dark:bg-slate-900">
          <img src="<%= saved_preview_url %>" alt="Supporting art preview" class="h-44 w-full object-cover" loading="lazy">
        </div>
        <p class="mt-3 text-sm font-semibold text-slate-900 dark:text-slate-100"><%= supporting_status %></p>
        <p class="text-xs text-slate-500 dark:text-slate-400">
          As soon as the next capture runs, the live cards will use this saved selection.
        </p>
      </div>
    </div>

    <div class="mt-4 rounded-2xl border border-amber-200 bg-amber-50 p-4 text-xs text-amber-800 dark:border-amber-300/50 dark:bg-amber-900/30 dark:text-amber-50">
      Saved changes auto-apply during the Refresh Stale job (roughly every three hours). Click "Re-capture screenshots" for immediate OG/Card/Simple refresh or run the full AI pipeline if you changed archetypes/AI art.
    </div>

    <form action="<%= update_my_profile_settings_path(username: profile.login) %>" method="post" class="mt-6 space-y-6" data-controller="submit-form">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <%= hidden_field_tag :tab, "backgrounds" %>
      <%= hidden_field_tag :apply_everywhere, "1" %>
      <input type="hidden" name="_method" value="patch">

      <div class="rounded-2xl border border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-800">
        <div class="flex flex-col gap-4 md:flex-row md:items-center">
          <div class="overflow-hidden rounded-xl border border-slate-200 bg-slate-100 dark:border-slate-700 dark:bg-slate-900">
            <img src="<%= saved_preview_url %>" alt="Supporting art preview" class="h-36 w-full object-cover" loading="lazy">
          </div>
          <div class="flex-1 space-y-1">
            <p class="text-sm font-semibold text-slate-900 dark:text-slate-100">One pick for every card</p>
            <p class="text-xs text-slate-500 dark:text-slate-400">Card, Card Pro, OG, OG Pro, Simple, square, and leaderboard captures stay in sync.</p>
          </div>
        </div>

        <div class="mt-4 grid gap-3 sm:grid-cols-3">
          <label class="cursor-pointer">
            <input type="radio" name="<%= choice_attr %>" value="library" class="peer sr-only" <%= "checked" if selected == "library" %>>
            <div class="rounded border-2 border-slate-200 p-2 text-center text-xs font-semibold text-slate-700 transition peer-checked:border-indigo-500 peer-checked:ring-2 peer-checked:ring-indigo-200 dark:border-slate-600 dark:text-slate-100 dark:peer-checked:ring-indigo-900">TecHub library</div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="<%= choice_attr %>" value="upload" class="peer sr-only" <%= "checked" if selected == "upload" %>>
            <div class="rounded border-2 border-slate-200 p-2 text-center text-xs font-semibold text-slate-700 transition peer-checked:border-indigo-500 peer-checked:ring-2 peer-checked:ring-indigo-200 dark:border-slate-600 dark:text-slate-100 dark:peer-checked:ring-indigo-900">Custom upload</div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="<%= choice_attr %>" value="color" class="peer sr-only" <%= "checked" if selected == "color" %>>
            <div class="rounded border-2 border-slate-200 p-2 text-center text-xs font-semibold text-slate-700 transition peer-checked:border-indigo-500 peer-checked:ring-2 peer-checked:ring-indigo-200 dark:border-slate-600 dark:text-slate-100 dark:peer-checked:ring-indigo-900">Solid colour</div>
          </label>
        </div>

        <div class="mt-3 flex items-center gap-3">
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Colour</label>
          <input type="color" name="<%= color_attr %>" value="<%= card&.public_send(color_attr) || '#0f172a' %>" class="h-10 w-20 rounded border border-slate-300 bg-white dark:border-slate-600 dark:bg-slate-900">
        </div>

        <details class="mt-3 rounded border border-dashed border-slate-300 bg-slate-50 p-3 text-xs text-slate-600 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-300">
          <summary class="cursor-pointer font-semibold text-slate-700 dark:text-slate-200">Browse TecHub art</summary>
          <div class="mt-2">
            <%= library_picker(options: @supporting_art_options, name: "bg_library_card", selected: library_value, image_ratio: "aspect-video", columns: "grid-cols-2 sm:grid-cols-3") %>
          </div>
        </details>

        <details class="mt-3 text-xs text-slate-600 dark:text-slate-400">
          <summary class="cursor-pointer select-none text-slate-700 dark:text-slate-300">Advanced: crop &amp; zoom</summary>
          <div class="mt-2 grid grid-cols-3 gap-2">
            <div>
              <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Crop X</label>
              <input type="number" step="0.01" min="0" max="1" name="<%= fx_attr %>" value="<%= card&.public_send(fx_attr) || 0.5 %>" class="<%= ui_input_class %>">
            </div>
            <div>
              <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Crop Y</label>
              <input type="number" step="0.01" min="0" max="1" name="<%= fy_attr %>" value="<%= card&.public_send(fy_attr) || 0.5 %>" class="<%= ui_input_class %>">
            </div>
            <div>
              <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Zoom</label>
              <input type="number" step="0.01" min="0.5" max="3" name="<%= zoom_attr %>" value="<%= card&.public_send(zoom_attr) || 1.0 %>" class="<%= ui_input_class %>">
            </div>
          </div>
        </details>
      </div>

      <div class="text-right">
        <button type="submit" class="<%= ui_primary_button_class %>" data-submit-form-target="button">
          <span data-submit-form-target="spinner" class="hidden">
            <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
            </svg>
          </span>
          <span data-submit-form-target="text">Save supporting art</span>
        </button>
      </div>
    </form>

    <div class="mt-6 rounded-lg border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-800">
      <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100 mb-2">Upload custom supporting art</h3>
      <p class="text-xs text-slate-500 dark:text-slate-400">Upload a square image (at least 1280×1280). We'll reuse it across Card, Card Pro, OG, OG Pro, Simple, square, and leaderboard screenshots.</p>
      <form action="<%= upload_my_profile_asset_path(username: profile.login) %>" method="post" enctype="multipart/form-data" class="mt-3 space-y-3" data-controller="submit-form">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <%= hidden_field_tag :tab, "backgrounds" %>
        <input type="hidden" name="kind" value="support_art_card">
        <input type="file" name="file" accept="image/*" class="<%= ui_file_input_class %> <%= 'opacity-60 cursor-not-allowed' unless uploads_enabled %>" <%= "disabled" unless uploads_enabled %>>
        <button type="submit" class="<%= ui_secondary_button_class %> w-full <%= 'opacity-60 cursor-not-allowed' unless uploads_enabled %>" <%= "disabled" unless uploads_enabled %> data-submit-form-target="button">
          <span data-submit-form-target="spinner" class="hidden">
            <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
            </svg>
          </span>
          <span data-submit-form-target="text">Upload supporting art</span>
        </button>
      </form>
      <% unless uploads_enabled %>
        <p class="mt-1 text-xs text-amber-600 dark:text-amber-400">Uploads are disabled in this environment.</p>
      <% end %>
    </div>
  </div>

  <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-lg transition dark:border-slate-700 dark:bg-slate-900 md:p-6">
    <h2 class="mb-4 text-xl font-bold text-slate-900 dark:text-slate-100">Regenerate</h2>
    <div class="grid gap-3 sm:grid-cols-2">
      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-800">
        <p class="mb-3 text-sm text-slate-600 dark:text-slate-300">Re-capture screenshots and optimise assets. No AI usage.</p>
        <%= button_to regenerate_my_profile_path(username: profile.login),
              method: :post,
              params: { tab: "backgrounds" },
              form: { data: { controller: "submit-form" } },
              class: "#{ui_secondary_button_class} w-full" do %>
          <span data-submit-form-target="spinner" class="hidden">
            <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
            </svg>
          </span>
          <span data-submit-form-target="text">Re-capture screenshots</span>
        <% end %>
      </div>

      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-800">
        <% available = Time.current >= (@ai_regen_available_at || Time.at(0)) %>
        <p class="mb-3 text-sm text-slate-600 dark:text-slate-300">Run the full AI pipeline (weekly limit).</p>
        <%= button_to regenerate_my_profile_ai_path(username: profile.login),
              method: :post,
              params: { tab: "backgrounds" },
              disabled: !available,
              form: { data: { controller: "submit-form" } },
              class: "#{ui_primary_button_class} w-full #{'opacity-60 cursor-not-allowed' unless available}" do %>
          <span data-submit-form-target="spinner" class="hidden">
            <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
            </svg>
          </span>
          <span data-submit-form-target="text"><%= available ? "Run full pipeline" : "Pipeline cooling down" %></span>
        <% end %>
        <% unless available %>
          <% remaining = (@ai_regen_available_at - Time.current).to_i %>
          <% hrs = (remaining / 3600).floor %>
          <% mins = ((remaining % 3600) / 60).floor %>
          <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">
            Available again in ~<%= hrs %>h <%= mins %>m (after <%= @ai_regen_available_at.strftime('%b %d, %Y %H:%M') %>)
          </p>
        <% end %>
      </div>
    </div>
  </div>
</div>
