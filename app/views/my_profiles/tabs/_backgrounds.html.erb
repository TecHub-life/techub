<%# Backgrounds Tab %>
<div class="space-y-6">
  <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-lg transition dark:border-slate-700 dark:bg-slate-900 md:p-6">
    <h2 class="mb-2 text-xl font-bold text-slate-900 dark:text-slate-100">Background Defaults</h2>
    <p class="mb-4 text-sm text-slate-600 dark:text-slate-300">
      Configure the default background behaviour for card, OG, and simple variants. You can still override each one with custom uploads.
    </p>

    <form action="<%= update_my_profile_settings_path(username: profile.login) %>" method="post" class="space-y-4" data-controller="submit-form">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <%= hidden_field_tag :tab, "backgrounds" %>

      <label for="apply_everywhere" class="flex items-center gap-3 text-sm text-slate-700 dark:text-slate-300">
        <input id="apply_everywhere" type="checkbox" name="apply_everywhere" value="1" class="<%= ui_checkbox_class %>">
        <span>Apply these defaults across all backgrounds</span>
      </label>

      <div class="grid gap-3 sm:grid-cols-3">
        <% card = profile.profile_card %>
        <% [
             { key: :card, label: "Card background" },
             { key: :og, label: "OG background" },
             { key: :simple, label: "Simple background" },
           ].each do |variant| %>
          <% choice_attr = :"bg_choice_#{variant[:key]}" %>
          <% color_attr  = :"bg_color_#{variant[:key]}" %>
          <% fx_attr     = :"bg_fx_#{variant[:key]}" %>
          <% fy_attr     = :"bg_fy_#{variant[:key]}" %>
          <% zoom_attr   = :"bg_zoom_#{variant[:key]}" %>
          <% library_value = bg_library_path_for(profile, variant[:key]) %>
          <% selected = card&.public_send(choice_attr) || "library" %>

          <div class="rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-600 dark:bg-slate-800">
            <label class="mb-1 block text-sm font-medium text-slate-900 dark:text-slate-100"><%= variant[:label] %></label>
            <select name="<%= choice_attr %>" class="<%= ui_select_class %>">
              <option value="library" <%= "selected" if selected == "library" %>>Library supporting art</option>
              <option value="upload" <%= "selected" if selected == "upload" %>>Custom upload</option>
              <option value="color" <%= "selected" if selected == "color" %>>Solid colour</option>
            </select>

            <input
              type="color"
              name="<%= color_attr %>"
              value="<%= card&.public_send(color_attr) || '#0f172a' %>"
              class="mt-3 h-10 w-20 rounded border border-slate-300 bg-white dark:border-slate-600 dark:bg-slate-900"
              title="<%= variant[:label] %> colour">

            <label class="mt-3 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Library art (used when Library is selected)</label>
            <select name="bg_library_<%= variant[:key] %>" class="<%= ui_select_class %>">
              <option value="">Automatic TecHub rotation</option>
              <% @supporting_art_options.each do |opt| %>
                <option value="<%= opt[:path] %>" <%= "selected" if opt[:path] == library_value %>><%= opt[:label] %></option>
              <% end %>
            </select>

            <details class="mt-3 text-xs text-slate-600 dark:text-slate-400">
              <summary class="cursor-pointer select-none text-slate-700 dark:text-slate-300">Advanced: crop &amp; zoom</summary>
              <div class="mt-2 grid grid-cols-3 gap-2">
                <div>
                  <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Crop X</label>
                  <input type="number" step="0.01" min="0" max="1" name="<%= fx_attr %>" value="<%= card&.public_send(fx_attr) || 0.5 %>" class="<%= ui_input_class %>">
                </div>
                <div>
                  <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Crop Y</label>
                  <input type="number" step="0.01" min="0" max="1" name="<%= fy_attr %>" value="<%= card&.public_send(fy_attr) || 0.5 %>" class="<%= ui_input_class %>">
                </div>
                <div>
                  <label class="mb-1 block text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Zoom</label>
                  <input type="number" step="0.01" min="0.5" max="3" name="<%= zoom_attr %>" value="<%= card&.public_send(zoom_attr) || 1.0 %>" class="<%= ui_input_class %>">
                </div>
              </div>
            </details>
          </div>
        <% end %>
      </div>

      <button type="submit" class="<%= ui_primary_button_class %>" data-submit-form-target="button">
        <span data-submit-form-target="spinner" class="hidden">
          <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
          </svg>
        </span>
        <span data-submit-form-target="text">Save background defaults</span>
      </button>
    </form>
  </div>

  <% uploads_enabled = defined?(Storage::ActiveStorageUploadService) %>
  <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-lg transition dark:border-slate-700 dark:bg-slate-900 md:p-6">
    <h2 class="mb-2 text-xl font-bold text-slate-900 dark:text-slate-100">Upload Supporting Art</h2>
    <p class="text-sm text-slate-600 dark:text-slate-300 mb-4">Provide custom artwork for your cards. Use square art for cards/OG/simple, or upload a square piece for social crops.</p>
    <form action="<%= upload_my_profile_asset_path(username: profile.login) %>" method="post" enctype="multipart/form-data" class="space-y-3" data-controller="submit-form">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <%= hidden_field_tag :tab, "backgrounds" %>
      <label class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Target</label>
      <select name="kind" class="<%= ui_select_class %>">
        <option value="support_art_card">Card (16:9)</option>
        <option value="support_art_og">OG / Link previews (16:9)</option>
        <option value="support_art_simple">Simple cards (16:9)</option>
        <option value="support_art_square">Square crops (1:1)</option>
      </select>
      <input type="file" name="file" accept="image/*" class="<%= ui_file_input_class %> <%= 'opacity-60 cursor-not-allowed' unless uploads_enabled %>" <%= "disabled" unless uploads_enabled %>>
      <button type="submit" class="<%= ui_secondary_button_class %> w-full <%= 'opacity-60 cursor-not-allowed' unless uploads_enabled %>" <%= "disabled" unless uploads_enabled %> data-submit-form-target="button">
        <span data-submit-form-target="spinner" class="hidden">
          <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
          </svg>
        </span>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
        </svg>
        <span data-submit-form-target="text">Upload supporting art</span>
      </button>
    </form>
    <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Recommended: JPG/PNG at least 1280Ã—1280 for square art. 16:9 variants crop automatically.</p>
    <% unless uploads_enabled %>
      <p class="mt-1 text-xs text-amber-600 dark:text-amber-400">Uploads are disabled in this environment.</p>
    <% end %>
  </div>

  <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-lg transition dark:border-slate-700 dark:bg-slate-900 md:p-6">
    <h2 class="mb-4 text-xl font-bold text-slate-900 dark:text-slate-100">Regenerate</h2>
    <div class="grid gap-3 sm:grid-cols-2">
      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-800">
        <p class="mb-3 text-sm text-slate-600 dark:text-slate-300">Re-capture screenshots and optimise assets. No AI usage.</p>
        <%= button_to regenerate_my_profile_path(username: profile.login),
              method: :post,
              params: { tab: "backgrounds" },
              form: { data: { controller: "submit-form" } },
              class: "#{ui_secondary_button_class} w-full" do %>
          <span data-submit-form-target="spinner" class="hidden">
            <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
            </svg>
          </span>
          <span data-submit-form-target="text">Re-capture screenshots</span>
        <% end %>
      </div>

      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-800">
        <% available = Time.current >= (@ai_regen_available_at || Time.at(0)) %>
        <p class="mb-3 text-sm text-slate-600 dark:text-slate-300">Run the full AI pipeline (weekly limit).</p>
        <%= button_to regenerate_my_profile_ai_path(username: profile.login),
              method: :post,
              params: { tab: "backgrounds" },
              disabled: !available,
              form: { data: { controller: "submit-form" } },
              class: "#{ui_primary_button_class} w-full #{'opacity-60 cursor-not-allowed' unless available}" do %>
          <span data-submit-form-target="spinner" class="hidden">
            <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
            </svg>
          </span>
          <span data-submit-form-target="text"><%= available ? "Run full pipeline" : "Pipeline cooling down" %></span>
        <% end %>
        <% unless available %>
          <% remaining = (@ai_regen_available_at - Time.current).to_i %>
          <% hrs = (remaining / 3600).floor %>
          <% mins = ((remaining % 3600) / 60).floor %>
          <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">
            Available again in ~<%= hrs %>h <%= mins %>m (after <%= @ai_regen_available_at.strftime('%b %d, %Y %H:%M') %>)
          </p>
        <% end %>
      </div>
    </div>
  </div>
</div>
