<% uploads_enabled = defined?(Storage::ActiveStorageUploadService) %>
<% default_avatar_mode = avatar_mode_for(profile, :default) %>
<% default_avatar_library = avatar_library_path_for(profile, :default) %>
<% avatar_variants = {
  profile: "Profile hero",
  card: "Trading card screenshot",
  og: "Open Graph / link preview",
  simple: "Simple card",
  square: "Square crops (X profile)",
  banner: "3×1 banner screenshot"
} %>
<% banner_choice = profile.banner_choice %>
<% banner_library_path = profile.banner_library_path %>
<% banner_preview = banner_image_url_for(profile) %>

<div class="rounded-xl border border-slate-200 bg-white p-4 md:p-6 shadow-lg dark:border-slate-700 dark:bg-slate-900 space-y-8">
  <div>
    <section class="space-y-5">
      <div>
        <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100">Avatars</h2>
        <p class="text-sm text-slate-600 dark:text-slate-400">Used across your TecHub hero, screenshots, and embeds. Override individual variants when you need a different vibe.</p>
      </div>
      <div class="flex items-center gap-4 rounded-lg border border-slate-200 bg-slate-50 p-4 dark:border-slate-700 dark:bg-slate-800">
        <img src="<%= avatar_image_url_for(profile) %>" alt="<%= profile.login %> avatar preview" class="h-16 w-16 rounded-full border-2 border-white shadow dark:border-slate-900" onerror="this.onerror=null; this.src='<%= asset_path("android-chrome-512x512.jpg") %>'">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Current preview</p>
          <p class="text-sm font-semibold text-slate-900 dark:text-slate-100"><%= avatar_source_label(profile) %></p>
        </div>
      </div>
      <form action="<%= update_my_profile_settings_path(username: profile.login) %>" method="post" class="space-y-5" data-controller="submit-form">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <%= hidden_field_tag :tab, "general" %>
        <input type="hidden" name="_method" value="patch">

        <fieldset class="space-y-3">
          <legend class="text-sm font-semibold text-slate-800 dark:text-slate-200">Default avatar</legend>
          <div class="grid gap-3 sm:grid-cols-3">
            <label class="cursor-pointer">
              <input type="radio" name="avatar_default_source" value="github" class="peer sr-only" <%= "checked" if default_avatar_mode == "github" %>>
              <div class="rounded-xl border-2 border-slate-200 bg-slate-50 p-3 text-center transition peer-checked:border-indigo-500 peer-checked:ring-2 peer-checked:ring-indigo-200 dark:border-slate-700 dark:bg-slate-900 dark:peer-checked:ring-indigo-900">
                <div class="aspect-square overflow-hidden rounded-lg bg-slate-100 dark:bg-slate-800">
                  <img src="<%= profile.avatar_url.presence || asset_path('android-chrome-512x512.jpg') %>" alt="GitHub avatar preview" class="h-full w-full object-cover">
                </div>
                <p class="mt-2 text-xs font-semibold text-slate-700 dark:text-slate-200">GitHub avatar</p>
              </div>
            </label>
            <label class="cursor-pointer">
              <input type="radio" name="avatar_default_source" value="upload" class="peer sr-only" <%= "checked" if default_avatar_mode == "upload" %>>
              <div class="rounded-xl border-2 border-slate-200 bg-slate-50 p-3 text-center transition peer-checked:border-indigo-500 peer-checked:ring-2 peer-checked:ring-indigo-200 dark:border-slate-700 dark:bg-slate-900 dark:peer-checked:ring-indigo-900">
                <div class="aspect-square overflow-hidden rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                  <% custom_avatar = profile_uploaded_asset_url(profile, "avatar_1x1") %>
                  <% if custom_avatar.present? %>
                    <img src="<%= custom_avatar %>" alt="Uploaded avatar preview" class="h-full w-full object-cover">
                  <% else %>
                    <span class="text-[11px] text-slate-500 dark:text-slate-400 px-3">Upload below to enable this option.</span>
                  <% end %>
                </div>
                <p class="mt-2 text-xs font-semibold text-slate-700 dark:text-slate-200">Custom upload</p>
              </div>
            </label>
            <label class="cursor-pointer">
              <input type="radio" name="avatar_default_source" value="library" class="peer sr-only" <%= "checked" if default_avatar_mode == "library" %>>
              <div class="rounded-xl border-2 border-slate-200 bg-slate-50 p-3 text-center transition peer-checked:border-indigo-500 peer-checked:ring-2 peer-checked:ring-indigo-200 dark:border-slate-700 dark:bg-slate-900 dark:peer-checked:ring-indigo-900">
                <div class="aspect-square overflow-hidden rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                  <% if default_avatar_mode == "library" && default_avatar_library.present? %>
                    <img src="<%= asset_path(default_avatar_library) %>" alt="Library avatar preview" class="h-full w-full object-cover">
                  <% else %>
                    <span class="text-[11px] text-slate-500 dark:text-slate-400 px-3 text-center">Pick from Spirit Animals, Archetypes, or TecHub avatars.</span>
                  <% end %>
                </div>
                <p class="mt-2 text-xs font-semibold text-slate-700 dark:text-slate-200">TecHub library</p>
              </div>
            </label>
          </div>
          <details class="rounded-lg border border-dashed border-slate-300 bg-white p-3 text-sm text-slate-600 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-300">
            <summary class="cursor-pointer font-medium text-slate-700 dark:text-slate-200">Browse library avatars</summary>
            <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Select when “TecHub library” is active. We’ll remember your choice for future sessions.</p>
            <div class="mt-3">
              <%= library_picker(options: @avatar_library_options, name: "avatar_default_library_path", selected: (default_avatar_mode == "library" ? default_avatar_library : nil)) %>
            </div>
          </details>
        </fieldset>

        <details class="rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-300">
          <summary class="cursor-pointer font-semibold text-slate-800 dark:text-slate-100">Advanced: per-screenshot overrides</summary>
          <div class="mt-3 space-y-4">
            <% avatar_variants.each do |variant, label| %>
              <% current_mode = avatar_mode_for(profile, variant) %>
              <% current_library = avatar_library_path_for(profile, variant) %>
              <div class="rounded-lg border border-slate-200 bg-white p-3 dark:border-slate-700 dark:bg-slate-900">
                <div class="flex items-center justify-between gap-2">
                  <p class="text-sm font-semibold text-slate-800 dark:text-slate-100"><%= label %></p>
                  <p class="text-xs text-slate-500 dark:text-slate-400"><%= avatar_source_label(profile, variant) %></p>
                </div>
                <select name="avatar_<%= variant %>_source" class="<%= ui_select_class %> mt-3">
                  <% unless variant == :default %>
                    <option value="inherit" <%= "selected" if current_mode == "inherit" %>>Inherit default</option>
                  <% end %>
                  <option value="github" <%= "selected" if current_mode == "github" %>>GitHub avatar</option>
                  <option value="upload" <%= "selected" if current_mode == "upload" %>>Custom upload</option>
                  <option value="library" <%= "selected" if current_mode == "library" %>>TecHub library</option>
                </select>
                <details class="mt-2 rounded border border-dashed border-slate-300 bg-slate-50 p-2 text-xs text-slate-500 dark:border-slate-600 dark:bg-slate-900">
                  <summary class="cursor-pointer font-semibold text-slate-700 dark:text-slate-200">Choose a library avatar</summary>
                  <div class="mt-2">
                    <%= library_picker(options: @avatar_library_options, name: "avatar_#{variant}_library_path", selected: (current_mode == "library" ? current_library : nil)) %>
                  </div>
                </details>
              </div>
            <% end %>
          </div>
        </details>

        <button type="submit" class="<%= ui_primary_button_class %> w-full" data-submit-form-target="button">
          <span data-submit-form-target="spinner" class="hidden">
            <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
            </svg>
          </span>
          <span data-submit-form-target="text">Save avatar settings</span>
        </button>
      </form>

      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 dark:border-slate-600 dark:bg-slate-800">
        <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100 mb-3">Upload custom avatar</h3>
        <form action="<%= upload_my_profile_asset_path(username: profile.login) %>" method="post" enctype="multipart/form-data" class="space-y-3" data-controller="submit-form">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <%= hidden_field_tag :tab, "general" %>
          <input type="hidden" name="kind" value="avatar_1x1">
          <input type="file" name="file" accept="image/*" class="<%= ui_file_input_class %> <%= 'opacity-60 cursor-not-allowed' unless uploads_enabled %>" <%= "disabled" unless uploads_enabled %>>
          <button type="submit" class="<%= ui_secondary_button_class %> w-full <%= 'opacity-60 cursor-not-allowed' unless uploads_enabled %>" <%= "disabled" unless uploads_enabled %> data-submit-form-target="button">
            <span data-submit-form-target="spinner" class="hidden">
              <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
              </svg>
            </span>
            <span data-submit-form-target="text">Upload avatar</span>
          </button>
        </form>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">PNG or JPG, 512×512 or larger. Uploads become reusable across every override.</p>
        <% unless uploads_enabled %>
          <p class="mt-1 text-xs text-amber-600 dark:text-amber-400">Uploads are disabled in this environment.</p>
        <% end %>
      </div>
    </section>
  </div>

  <div>
    <section class="space-y-5">
      <div>
        <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100">Profile banner</h2>
        <p class="text-sm text-slate-600 dark:text-slate-400">Sits above your hero layout and powers the 3×1 banner screenshots.</p>
      </div>
      <form action="<%= update_my_profile_settings_path(username: profile.login) %>" method="post" class="space-y-4" data-controller="submit-form">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <%= hidden_field_tag :tab, "general" %>
        <input type="hidden" name="_method" value="patch">
        <div class="grid gap-3 sm:grid-cols-3">
          <label class="cursor-pointer">
            <input type="radio" name="banner_choice" value="none" class="peer sr-only" <%= "checked" if banner_choice == "none" %>>
            <div class="rounded-xl border-2 border-slate-200 bg-slate-50 p-3 text-center text-xs font-semibold text-slate-700 transition peer-checked:border-indigo-500 peer-checked:ring-2 peer-checked:ring-indigo-200 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200 dark:peer-checked:ring-indigo-900">
              No banner
            </div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="banner_choice" value="library" class="peer sr-only" <%= "checked" if banner_choice == "library" %>>
            <div class="rounded-xl border-2 border-slate-200 bg-slate-50 p-3 transition peer-checked:border-indigo-500 peer-checked:ring-2 peer-checked:ring-indigo-200 dark:border-slate-700 dark:bg-slate-900 dark:peer-checked:ring-indigo-900">
              <div class="aspect-[3/1] overflow-hidden rounded-lg bg-slate-100 dark:bg-slate-800">
                <% if banner_choice == "library" && banner_library_path.present? %>
                  <img src="<%= asset_path(banner_library_path) %>" alt="Banner library preview" class="h-full w-full object-cover">
                <% else %>
                  <div class="flex h-full items-center justify-center px-3 text-[11px] text-slate-500 dark:text-slate-400 text-center">Browse TecHub banners</div>
                <% end %>
              </div>
              <p class="mt-2 text-xs font-semibold text-slate-700 dark:text-slate-200 text-center">TecHub banners</p>
            </div>
          </label>
          <label class="cursor-pointer">
            <input type="radio" name="banner_choice" value="upload" class="peer sr-only" <%= "checked" if banner_choice == "upload" %>>
            <div class="rounded-xl border-2 border-slate-200 bg-slate-50 p-3 transition peer-checked:border-indigo-500 peer-checked:ring-2 peer-checked:ring-indigo-200 dark:border-slate-700 dark:bg-slate-900 dark:peer-checked:ring-indigo-900">
              <div class="aspect-[3/1] overflow-hidden rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                <% custom_banner = profile_uploaded_asset_url(profile, "banner_3x1") %>
                <% if custom_banner.present? %>
                  <img src="<%= custom_banner %>" alt="Uploaded banner preview" class="h-full w-full object-cover">
                <% else %>
                  <span class="text-[11px] text-slate-500 dark:text-slate-400 px-3 text-center">Upload a 3×1 banner below.</span>
                <% end %>
              </div>
              <p class="mt-2 text-xs font-semibold text-slate-700 dark:text-slate-200 text-center">Custom upload</p>
            </div>
          </label>
        </div>

        <details class="rounded-lg border border-dashed border-slate-300 bg-white p-3 text-sm text-slate-600 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-300">
          <summary class="cursor-pointer font-medium text-slate-700 dark:text-slate-200">Browse TecHub banners</summary>
          <div class="mt-3">
            <%= library_picker(options: @banner_library_options, name: "banner_library_path", selected: (banner_choice == "library" ? banner_library_path : nil), image_ratio: "aspect-[3/1]", columns: "grid-cols-1 sm:grid-cols-2") %>
          </div>
        </details>

        <div class="rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-900">
          <% if banner_choice == "none" %>
            <p class="text-sm text-slate-600 dark:text-slate-400">Your hero layout will display without a banner.</p>
          <% elsif banner_preview.present? %>
            <div class="space-y-2">
              <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Preview</p>
              <img src="<%= banner_preview %>" alt="Banner preview" class="w-full rounded-lg border border-slate-200 object-cover dark:border-slate-700">
              <p class="text-xs text-slate-500 dark:text-slate-400">Displayed above the hero section and captured in 3×1 banner screenshots.</p>
            </div>
          <% else %>
            <p class="text-sm text-slate-600 dark:text-slate-400">Select a library or uploaded banner to see the preview.</p>
          <% end %>
        </div>

        <button type="submit" class="<%= ui_primary_button_class %> w-full" data-submit-form-target="button">
          <span data-submit-form-target="spinner" class="hidden">
            <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
            </svg>
          </span>
          <span data-submit-form-target="text">Save banner settings</span>
        </button>
      </form>

      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 dark:border-slate-600 dark:bg-slate-800">
        <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100 mb-3">Upload custom banner (3×1)</h3>
        <form action="<%= upload_my_profile_asset_path(username: profile.login) %>" method="post" enctype="multipart/form-data" class="space-y-3" data-controller="submit-form">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <%= hidden_field_tag :tab, "general" %>
          <input type="hidden" name="kind" value="banner_3x1">
          <input type="file" name="file" accept="image/*" class="<%= ui_file_input_class %> <%= 'opacity-60 cursor-not-allowed' unless uploads_enabled %>" <%= "disabled" unless uploads_enabled %>>
          <button type="submit" class="<%= ui_secondary_button_class %> w-full <%= 'opacity-60 cursor-not-allowed' unless uploads_enabled %>" <%= "disabled" unless uploads_enabled %> data-submit-form-target="button">
            <span data-submit-form-target="spinner" class="hidden">
              <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
              </svg>
            </span>
            <span data-submit-form-target="text">Upload banner</span>
          </button>
        </form>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">PNG/JPG at least 1500×500. Uploaded banners can double as supporting art backgrounds.</p>
        <% unless uploads_enabled %>
          <p class="mt-1 text-xs text-amber-600 dark:text-amber-400">Uploads are disabled in this environment.</p>
        <% end %>
      </div>
    </section>
  </div>
</div>
