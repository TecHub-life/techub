<%# General Settings Tab %>
<div class="space-y-6">
  <% card = profile.profile_card %>
  <div class="rounded-xl border border-slate-200 bg-white p-4 md:p-6 shadow-lg dark:border-slate-700 dark:bg-slate-900">
    <div class="mb-4">
      <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100">AI Profile Snapshot</h2>
      <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">Everything the AI generated for your trading card and social persona.</p>
    </div>
    <% if card.present? %>
      <div class="space-y-6 md:space-y-0 md:grid md:grid-cols-2 md:gap-6">
        <div class="space-y-4">
          <div class="space-y-1 text-sm text-slate-700 dark:text-slate-300">
            <% if card.title.present? %>
              <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600 dark:text-indigo-300">Title</p>
              <p class="text-base font-semibold text-slate-900 dark:text-slate-100"><%= card.title %></p>
            <% end %>
            <% if card.tagline.present? %>
              <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600 dark:text-indigo-300 mt-3">Tagline</p>
              <p class="italic text-slate-600 dark:text-slate-400"><%= card.tagline %></p>
            <% end %>
            <% if card.flavor_text.present? %>
              <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600 dark:text-indigo-300 mt-3">Flavor Text</p>
              <p class="italic text-slate-500 dark:text-slate-400">"<%= card.flavor_text %>"</p>
            <% end %>
          </div>

          <div>
            <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Stats</h3>
            <div class="mt-2 flex flex-wrap gap-2">
              <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2.5 py-1 text-xs font-semibold text-amber-700 dark:bg-amber-900/40 dark:text-amber-300">‚öîÔ∏è Attack <%= card.attack %></span>
              <span class="inline-flex items-center gap-1 rounded-full bg-blue-100 px-2.5 py-1 text-xs font-semibold text-blue-700 dark:bg-blue-900/40 dark:text-blue-300">üõ°Ô∏è Defense <%= card.defense %></span>
              <span class="inline-flex items-center gap-1 rounded-full bg-emerald-100 px-2.5 py-1 text-xs font-semibold text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300">‚ö° Speed <%= card.speed %></span>
            </div>
          </div>

          <div class="space-y-3">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-400">Buff</p>
              <p class="text-sm font-semibold text-slate-900 dark:text-slate-100"><%= card.buff %></p>
              <% if card.buff_description.present? %>
                <p class="text-xs text-slate-600 dark:text-slate-400 mt-1"><%= card.buff_description %></p>
              <% end %>
            </div>
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-amber-600 dark:text-amber-400">Weakness</p>
              <p class="text-sm font-semibold text-slate-900 dark:text-slate-100"><%= card.weakness %></p>
              <% if card.weakness_description.present? %>
                <p class="text-xs text-slate-600 dark:text-slate-400 mt-1"><%= card.weakness_description %></p>
              <% end %>
            </div>
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-teal-600 dark:text-teal-400">Vibe</p>
              <p class="text-sm font-semibold text-slate-900 dark:text-slate-100"><%= card.vibe %></p>
              <% if card.vibe_description.present? %>
                <p class="text-xs text-slate-600 dark:text-slate-400 mt-1"><%= card.vibe_description %></p>
              <% end %>
            </div>
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-indigo-600 dark:text-indigo-300">Special Move</p>
            <p class="text-sm font-semibold text-indigo-900 dark:text-indigo-100"><%= card.special_move %></p>
            <% if card.special_move_description.present? %>
              <p class="text-xs text-indigo-700 dark:text-indigo-300 mt-1"><%= card.special_move_description %></p>
            <% end %>
          </div>

          <div>
            <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Card Attributes</h3>
            <div class="mt-2 space-y-2 text-sm text-slate-700 dark:text-slate-300">
              <% if card.playing_card.present? %>
                <div class="flex items-center justify-between">
                  <span>Playing Card</span>
                  <span class="font-semibold text-slate-900 dark:text-slate-100"><%= card.playing_card %></span>
                </div>
              <% end %>
              <% if card.spirit_animal.present? %>
                <div class="flex items-center justify-between">
                  <span>Spirit Animal</span>
                  <span class="font-semibold text-slate-900 dark:text-slate-100"><%= card.spirit_animal %></span>
                </div>
              <% end %>
              <% if card.archetype.present? %>
                <div class="flex items-center justify-between">
                  <span>Archetype</span>
                  <span class="font-semibold text-slate-900 dark:text-slate-100"><%= card.archetype %></span>
                </div>
              <% end %>
            </div>
          </div>

          <% if Array(card.tags).any? %>
            <div>
              <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Tags</h3>
              <div class="mt-2 flex flex-wrap gap-1.5">
                <% Array(card.tags).each do |tag| %>
                  <span class="inline-flex items-center rounded-full bg-indigo-100 px-2 py-1 text-xs font-medium text-indigo-700 dark:bg-indigo-900/40 dark:text-indigo-300">#<%= tag %></span>
                <% end %>
              </div>
            </div>
          <% end %>

          <% if card.short_bio.present? %>
            <div>
              <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Short Bio</h3>
              <p class="mt-1 text-sm text-slate-600 dark:text-slate-400"><%= card.short_bio %></p>
            </div>
          <% end %>

          <% if card.long_bio.present? %>
            <div>
              <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Long Bio</h3>
              <div class="mt-1 max-h-48 overflow-y-auto text-sm text-slate-600 dark:text-slate-400">
                <%= simple_format(card.long_bio) %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <p class="text-sm text-slate-600 dark:text-slate-400">No AI card has been generated yet. Run the full pipeline to populate these fields.</p>
    <% end %>
  </div>

  <div class="rounded-xl border border-slate-200 bg-white p-4 md:p-6 shadow-lg dark:border-slate-700 dark:bg-slate-900">
    <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4">Privacy & Sharing</h2>
    <form action="<%= update_my_profile_settings_path(username: profile.login) %>" method="post" class="space-y-4" data-controller="submit-form">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <input type="hidden" name="_method" value="patch">
      <label class="inline-flex items-center gap-3 text-sm md:text-base cursor-pointer text-slate-700 dark:text-slate-300">
        <input type="hidden" name="ai_art_opt_in" value="0">
        <input type="checkbox" name="ai_art_opt_in" value="1" <%= 'checked' if profile.ai_art_opt_in %> class="<%= ui_checkbox_class %>">
        <span>Allow my AI artwork to be featured publicly (gallery & promos)</span>
      </label>

      <div class="pt-2">
        <p class="text-sm font-semibold text-slate-800 dark:text-slate-200 mb-1">Available for hire badge</p>
        <div class="flex items-center gap-3">
          <label class="inline-flex items-center gap-2 cursor-pointer text-slate-700 dark:text-slate-300">
            <input type="hidden" name="hireable_override" value="0">
            <input type="checkbox" name="hireable_override" value="1" <%= 'checked' if profile.hireable_display? %> class="<%= ui_checkbox_class %>">
            <span>Show the ‚ÄúAvailable for hire‚Äù badge on my profile</span>
          </label>
        </div>
        <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">You control this here. Toggle on/off anytime.</p>
      </div>
      <div class="flex items-center gap-3">
        <button type="submit" class="<%= ui_primary_button_class %>" data-submit-form-target="button">
          <span data-submit-form-target="spinner" class="hidden">
            <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
            </svg>
          </span>
          <span data-submit-form-target="text">Save changes</span>
        </button>
        <a href="/gallery" target="_blank" class="text-sm font-medium text-indigo-600 hover:text-indigo-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300">View public gallery ‚Üí</a>
      </div>
    </form>
  </div>

  <div class="rounded-xl border border-slate-200 bg-white p-4 md:p-6 shadow-lg dark:border-slate-700 dark:bg-slate-900">
    <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-4">Avatar Selection</h2>
    <form action="<%= update_my_profile_settings_path(username: profile.login) %>" method="post" class="space-y-4" data-controller="submit-form">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <input type="hidden" name="_method" value="patch">
      <% choice = profile.profile_card&.avatar_choice || 'real' %>
      <% base = Rails.root.join('public','generated', profile.login) %>
      <% ai_opts = [] %>
      <% if Dir.exist?(base) %>
        <% ai_opts = Dir[base.join('avatar-1x1*.{jpg,jpeg,png}').to_s].first(3) %>
      <% end %>
      
      <% if ai_opts.empty? %>
        <p class="text-sm text-slate-600 dark:text-slate-300 mb-3">
          No generated avatars yet. Run the full pipeline to create some options.
        </p>
      <% end %>
      
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-3">
        <label class="cursor-pointer">
          <input type="radio" name="avatar_choice" value="real" <%= 'checked' if choice == 'real' %> class="peer sr-only">
          <div class="rounded border-2 border-slate-300 p-2 transition peer-checked:border-indigo-500 peer-checked:ring-2 peer-checked:ring-indigo-200 peer-focus-visible:ring-2 peer-focus-visible:ring-sky-400 peer-focus-visible:outline-none dark:border-slate-700 dark:peer-checked:ring-indigo-900 dark:peer-focus-visible:ring-sky-500">
            <div class="aspect-square overflow-hidden rounded bg-slate-100 dark:bg-slate-900">
              <img src="<%= avatar_image_url_for(profile) %>" alt="GitHub avatar" class="h-full w-full object-cover" onerror="this.onerror=null; this.src='<%= asset_path("android-chrome-512x512.jpg") %>'">
            </div>
            <div class="mt-1.5 text-center text-xs font-medium text-slate-700 dark:text-slate-300">GitHub</div>
          </div>
        </label>

        <% ai_opts.each_with_index do |path, idx| %>
          <label class="cursor-pointer">
            <input type="radio" name="avatar_choice" value="ai" <%= 'checked' if choice == 'ai' %> class="peer sr-only">
            <div class="rounded border-2 border-slate-300 p-2 transition peer-checked:border-indigo-500 peer-checked:ring-2 peer-checked:ring-indigo-200 peer-focus-visible:ring-2 peer-focus-visible:ring-sky-400 peer-focus-visible:outline-none dark:border-slate-700 dark:peer-checked:ring-indigo-900 dark:peer-focus-visible:ring-sky-500">
              <div class="aspect-square overflow-hidden rounded bg-slate-100 dark:bg-slate-900">
                <img src="<%= "/generated/#{profile.login}/#{File.basename(path)}" %>" alt="AI avatar <%= idx+1 %>" class="h-full w-full object-cover">
              </div>
              <div class="mt-1.5 text-center text-xs font-medium text-slate-700 dark:text-slate-300">AI <%= idx+1 %></div>
            </div>
          </label>
        <% end %>
      </div>
      <button type="submit" class="<%= ui_primary_button_class %>" data-submit-form-target="button">
        <span data-submit-form-target="spinner" class="hidden">
          <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
          </svg>
        </span>
        <span data-submit-form-target="text">Save avatar choice</span>
      </button>
    </form>

    <% uploads_enabled = defined?(Storage::ActiveStorageUploadService) %>
    <div class="mt-6 rounded-lg border border-slate-200 bg-slate-50 p-4 dark:border-slate-600 dark:bg-slate-800">
      <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100 mb-3">Upload Custom Avatar</h3>
      <form action="<%= upload_my_profile_asset_path(username: profile.login) %>" method="post" enctype="multipart/form-data" class="space-y-4" data-controller="submit-form">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <input type="hidden" name="kind" value="avatar_1x1">
        <input type="file" name="file" accept="image/*" class="<%= ui_file_input_class %> <%= 'opacity-60 cursor-not-allowed' unless uploads_enabled %>" <%= "disabled" unless uploads_enabled %>>
        <button type="submit" class="<%= ui_secondary_button_class %> w-full <%= 'opacity-60 cursor-not-allowed' unless uploads_enabled %>" <%= "disabled" unless uploads_enabled %> data-submit-form-target="button">
          <span data-submit-form-target="spinner" class="hidden">
            <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V2C5.373 2 1 6.373 1 12h3zm2 5.291A7.962 7.962 0 014 12H1c0 3.042 1.135 5.824 3 7.938l2-2.647z"></path>
            </svg>
          </span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
          <span data-submit-form-target="text">Upload avatar</span>
        </button>
      </form>
      <p class="mt-2 text-xs text-slate-500">Upload your own avatar image. Recommended: square image, at least 400x400px.</p>
      <% unless uploads_enabled %>
        <p class="mt-1 text-xs text-amber-600 dark:text-amber-400">Uploads are disabled in this environment.</p>
      <% end %>
    </div>
  </div>
</div>
