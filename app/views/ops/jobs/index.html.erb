<section class="mx-auto max-w-4xl space-y-6 px-4 py-12">
  <h1 class="text-2xl font-bold text-slate-900 dark:text-slate-100">Jobs Status</h1>

  <% if @engine_present %>
    <div class="rounded border border-slate-200 bg-white p-4 text-slate-700 shadow-sm dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200">
      Mission Control is installed. Prefer the full UI at <code>/ops/jobs</code>.
    </div>
  <% end %>

  <div class="grid gap-4 sm:grid-cols-2">
    <div class="rounded border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
      <div class="text-sm text-slate-500 dark:text-slate-400">Adapter</div>
      <div class="text-lg font-semibold"><%= @adapter.class.name %></div>
    </div>
    <div class="rounded border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
      <div class="text-sm text-slate-500 dark:text-slate-400">Queue DB</div>
      <div class="text-lg font-semibold">storage/development_queue.sqlite3</div>
    </div>
  </div>

  <% if @error.present? %>
    <div class="rounded border border-red-300 bg-red-50 p-4 text-red-700 dark:border-red-800 dark:bg-red-900/20 dark:text-red-300">
      <strong>Error:</strong> <%= @error %>
    </div>
  <% end %>

  <div class="grid gap-4 sm:grid-cols-3">
    <div class="rounded border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
      <div class="text-sm text-slate-500 dark:text-slate-400">Queued (pending)</div>
      <div class="text-2xl font-bold"><%= @stats[:queued] || '—' %></div>
    </div>
    <div class="rounded border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
      <div class="text-sm text-slate-500 dark:text-slate-400">Ready</div>
      <div class="text-2xl font-bold"><%= @stats[:ready] || '—' %></div>
    </div>
    <div class="rounded border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
      <div class="text-sm text-slate-500 dark:text-slate-400">Running</div>
      <div class="text-2xl font-bold"><%= @stats[:running] || '—' %></div>
    </div>
  </div>

  <div class="grid gap-4 sm:grid-cols-3">
    <div class="rounded border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
      <div class="text-sm text-slate-500 dark:text-slate-400">Failed</div>
      <div class="text-2xl font-bold"><%= @stats[:failed] || '—' %></div>
    </div>
    <div class="rounded border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
      <div class="text-sm text-slate-500 dark:text-slate-400">Finished (last hour)</div>
      <div class="text-2xl font-bold"><%= @stats[:finished_last_hour] || '—' %></div>
    </div>
  </div>

  <div class="rounded border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
    <h2 class="text-lg font-semibold mb-3">Processes</h2>
    <% if @stats[:processes].present? %>
      <ul class="text-sm">
        <% @stats[:processes].each do |p| %>
          <li class="flex items-center justify-between border-b border-slate-200 py-2 last:border-0 dark:border-slate-700">
            <span><%= p.name %></span>
            <span class="text-slate-500 dark:text-slate-400"><%= p.last_heartbeat_at&.strftime('%H:%M:%S') || '—' %></span>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="text-slate-600 dark:text-slate-300">No worker processes detected. Make sure bin/dev is running and includes the jobs process.</p>
      <pre class="mt-2 rounded bg-slate-900/80 p-3 text-xs text-slate-100"># Procfile.dev
web: bin/rails server
css: bin/rails tailwindcss:watch
jobs: bin/jobs start</pre>
    <% end %>
  </div>

  <div class="rounded border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800">
    <h2 class="text-lg font-semibold mb-3">Recent Pipeline Stages</h2>
    <% if @recent_events.present? %>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700">
              <th class="py-2 pr-4">Time</th>
              <th class="py-2 pr-4">Profile</th>
              <th class="py-2 pr-4">Stage</th>
              <th class="py-2 pr-4">Status</th>
              <th class="py-2 pr-4">Duration</th>
              <th class="py-2">Message</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_events.each do |e| %>
              <tr class="border-b border-slate-100 dark:border-slate-800">
                <td class="py-2 pr-4"><%= e.created_at.strftime('%H:%M:%S') %></td>
                <td class="py-2 pr-4"><a href="<%= profile_path(username: e.profile.login) %>" class="text-blue-600 dark:text-blue-400">@<%= e.profile.login %></a></td>
                <td class="py-2 pr-4"><%= e.stage %></td>
                <td class="py-2 pr-4"><%= e.status %></td>
                <td class="py-2 pr-4"><%= e.duration_ms ? "#{e.duration_ms} ms" : '—' %></td>
                <td class="py-2"><%= e.message.to_s.truncate(80) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-slate-600 dark:text-slate-300">No recent stage events. Run a pipeline to populate this table.</p>
    <% end %>
  </div>
</section>
