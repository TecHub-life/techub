#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require_relative "../config/environment"

def emoji_for(status)
  case status.to_s
  when "ok"
    "✅"
  when "degraded"
    "⚠️ "
  else
    "❌"
  end
end

def print_step(step)
  status = step[:status] || "ok"
  label = step[:label] || step[:id]
  puts "#{emoji_for(status)} #{label} (#{step[:id]})"
  puts "    #{step[:message]}" if step[:message].present?
  metadata = step[:metadata] || {}
  metadata.each do |key, value|
    next if value.nil? || (value.respond_to?(:empty?) && value.empty?)
    puts "    - #{key}: #{value.inspect}"
  end
end

result = Importmap::DoctorService.call

puts "\n== Importmap Doctor =="
Array(result.metadata[:steps]).each { |step| print_step(step) }

if result.degraded?
  warn "\nImportmap doctor finished with warnings (status: degraded)"
elsif result.failure?
  warn "\nImportmap doctor failed"
else
  puts "\nImportmap doctor passed"
end

exit(result.failure? ? 1 : 0)
