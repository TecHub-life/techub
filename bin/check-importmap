#!/usr/bin/env ruby
# frozen_string_literal: true

# Validates importmap integrity:
# 1. Ensures all imports in application.js are pinned in importmap.rb
# 2. Verifies all controller files are accessible via importmap
# 3. Checks that critical dependencies are present

require "pathname"

def error(msg)
  warn "‚ùå #{msg}"
  exit 1
end

def success(msg)
  puts "‚úÖ #{msg}"
end

# Parse importmap.rb to extract pins
importmap_rb_path = Pathname.new("config/importmap.rb")
unless importmap_rb_path.exist?
  error "config/importmap.rb not found"
end

importmap_content = importmap_rb_path.read
pins = {}

# Extract pin statements
importmap_content.scan(/^pin\s+"([^"]+)"/) do |match|
  pins[match[0]] = true
end

# Extract pin_all_from statements
pin_all_from_patterns = []
importmap_content.scan(/^pin_all_from\s+"([^"]+)"(?:,\s*under:\s+"([^"]+)")?/) do |match|
  dir = match[0]
  under = match[1] || ""
  pin_all_from_patterns << { dir: dir, under: under }
end

# Check 1: Verify all imports from application.js are pinned
app_js_path = Pathname.new("app/javascript/application.js")
unless app_js_path.exist?
  error "app/javascript/application.js not found"
end

app_js_content = app_js_path.read
app_js_imports = app_js_content.scan(/^import\s+(?:'([^']+)'|"([^"]+)")/).flatten.compact

puts "\nüì¶ Checking imports from application.js..."
app_js_imports.each do |import_name|
  # Check if it's a direct pin
  is_pinned = pins.key?(import_name)
  
  # Check if it's covered by pin_all_from (e.g., "controllers" is covered by pin_all_from with under: "controllers")
  unless is_pinned
    is_pinned = pin_all_from_patterns.any? { |p| p[:under] == import_name }
  end
  
  unless is_pinned
    error "Import '#{import_name}' from application.js is not pinned in importmap.rb"
  end
  success "Import '#{import_name}' is pinned"
end

# Check 2: Verify all controller files are accessible
puts "\nüéÆ Checking Stimulus controllers..."
controllers_dir = Pathname.new("app/javascript/controllers")
if controllers_dir.exist?
  controller_files = controllers_dir.glob("**/*_controller.js")
  
  # Check if pin_all_from covers controllers
  has_controllers_pin = pin_all_from_patterns.any? { |p| p[:dir] == "app/javascript/controllers" && p[:under] == "controllers" }
  
  unless has_controllers_pin
    error "Missing 'pin_all_from \"app/javascript/controllers\", under: \"controllers\"' in importmap.rb"
  end
  
  success "All #{controller_files.size} Stimulus controllers are accessible via pin_all_from"
else
  warn "‚ö†Ô∏è  No controllers directory found at app/javascript/controllers"
end

# Check 3: Verify critical dependencies are present
puts "\nüîß Checking critical dependencies..."
critical_deps = [
  "@hotwired/turbo-rails",
  "@hotwired/stimulus",
  "@hotwired/stimulus-loading"
]

critical_deps.each do |dep|
  unless pins.key?(dep)
    error "Critical dependency '#{dep}' is missing from importmap.rb"
  end
  success "Critical dependency '#{dep}' is present"
end

# Check 4: Verify techub_console.js is pinned
puts "\nüéØ Checking custom modules..."
custom_modules = ["techub_console"]

custom_modules.each do |mod|
  unless pins.key?(mod)
    error "Custom module '#{mod}' is not pinned in importmap.rb"
  end
  
  # Verify the file exists
  mod_path = Pathname.new("app/javascript/#{mod}.js")
  unless mod_path.exist?
    error "Custom module file '#{mod_path}' does not exist"
  end
  
  success "Custom module '#{mod}' is pinned and file exists"
end

puts "\n‚ú® Importmap validation passed! All imports are properly configured."
